<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>World 3-1: Enactus Rush</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#1A1040}
body{font-family:'Press Start 2P',cursive}
canvas{display:block;width:100vw;height:100vh}

.overlay{
  position:fixed;inset:0;z-index:100;
  display:none;align-items:center;justify-content:center;
  flex-direction:column;text-align:center;
}
.overlay.show{display:flex}

.start-bg{background:rgba(20,10,50,.94)}
.s-title{
  font-size:20px;color:#FFC107;
  text-shadow:0 0 30px rgba(255,193,7,.4),0 0 60px rgba(255,193,7,.15),2px 2px 0 #000;
  margin-bottom:10px;
}
.s-sub{font-size:9px;color:#B0A0D0;margin-bottom:25px}
.s-desc{font-size:6.5px;color:#A090C0;line-height:2.8;margin-bottom:20px;max-width:340px}
.s-keys{
  font-size:6px;color:#8878AA;line-height:3;margin-bottom:30px;
  background:rgba(255,193,7,.04);padding:14px 20px;border-radius:8px;
  border:1px solid rgba(255,193,7,.15);
}
.s-keys b{color:#FFC107}
.s-btn{
  font-family:'Press Start 2P',cursive;font-size:13px;
  color:#FFF;
  background:linear-gradient(180deg,#E8A000,#C08000);
  border:none;border-radius:6px;padding:16px 50px;cursor:pointer;
  box-shadow:0 4px 0 #805000,0 0 25px rgba(255,180,0,.3);
  animation:btnGlow 2s ease-in-out infinite;
  transition:all .1s;pointer-events:auto;
}
.s-btn:hover{background:linear-gradient(180deg,#FFB820,#D89000);transform:scale(1.04)}
.s-btn:active{transform:translateY(4px);box-shadow:0 0 0 #805000}
@keyframes btnGlow{
  0%,100%{box-shadow:0 4px 0 #805000,0 0 25px rgba(255,180,0,.3)}
  50%{box-shadow:0 4px 0 #805000,0 0 40px rgba(255,180,0,.5)}
}

.s-hearts{font-size:28px;margin-bottom:15px;letter-spacing:8px}

.go-bg{background:rgba(15,5,30,.93)}
.go-title{font-size:16px;color:#FF4060;margin-bottom:15px;text-shadow:0 0 15px rgba(255,64,96,.3)}
.go-sub{font-size:7px;color:#8878AA;margin-bottom:8px}
.go-score{font-size:9px;color:#FFC107;margin-bottom:20px}
.go-btn{
  font-family:'Press Start 2P',cursive;font-size:10px;
  color:#FFF;background:linear-gradient(180deg,#E8A000,#C08000);
  border:none;border-radius:5px;padding:13px 30px;cursor:pointer;
  box-shadow:0 4px 0 #805000;pointer-events:auto;
}
.go-btn:hover{background:linear-gradient(180deg,#FFB820,#D89000)}
.go-btn:active{transform:translateY(4px);box-shadow:none}

.story-bg{background:rgba(15,5,30,.94)}
.story-card{
  width:620px;max-width:92vw;max-height:85vh;
  background:linear-gradient(180deg,#FFF8E8,#FFF0D0);
  border:4px solid #E0C080;border-radius:12px;
  box-shadow:0 0 60px rgba(255,180,0,.15),inset 0 0 20px rgba(255,200,100,.1);
  padding:28px;overflow-y:auto;
  animation:cardIn .6s cubic-bezier(.34,1.56,.64,1);pointer-events:auto;
}
@keyframes cardIn{
  0%{transform:scale(0) rotate(180deg);opacity:0}
  60%{transform:scale(1.03) rotate(-2deg);opacity:1}
  100%{transform:scale(1) rotate(0);opacity:1}
}
.sc-head{font-size:11px;color:#C08000;text-align:center;margin-bottom:12px}
.sc-div{width:100%;height:3px;background:linear-gradient(90deg,transparent,#E0C080,transparent);margin-bottom:16px}
.sc-txt{font-size:10px;line-height:2.6;color:#604830}
.sc-txt p{margin-bottom:12px}
.sc-foot{
  display:flex;justify-content:space-between;margin-top:20px;
  padding-top:16px;border-top:1px solid #E0C080;
}
.btn-s{
  font-family:'Press Start 2P',cursive;font-size:7px;
  padding:11px 18px;border-radius:5px;cursor:pointer;border:none;transition:all .12s;
}
.btn-back{color:#FFF;background:#888;box-shadow:0 3px 0 #555}
.btn-back:hover{background:#999}
.btn-back:active{transform:translateY(3px);box-shadow:none}
.btn-next{color:#FFF;background:#E8A000;box-shadow:0 3px 0 #805000}
.btn-next:hover{background:#FFB820}
.btn-next:active{transform:translateY(3px);box-shadow:none}

.mob{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  z-index:50;display:none;gap:16px;pointer-events:auto;
}
.mob.show{display:flex}
.mb{
  width:58px;height:58px;
  background:rgba(255,193,7,.1);border:2px solid rgba(255,193,7,.25);
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:20px;color:rgba(255,193,7,.6);cursor:pointer;
  -webkit-tap-highlight-color:transparent;user-select:none;
  backdrop-filter:blur(6px);
}
.mb:active{background:rgba(255,193,7,.3);color:#FFF}

.sc-txt p.ar{
  direction:rtl;text-align:center;
  font-size:16px;line-height:2;color:#705030;
}

@media(max-width:600px){
  .s-title{font-size:15px}
  .story-card{padding:18px}
  .sc-txt{font-size:8px}
  .sc-head{font-size:9px}
  .sc-txt p.ar{font-size:13px;line-height:3.5}
}
</style>
</head>
<body>

<canvas id="game"></canvas>

<div class="overlay start-bg show" id="oStart">
  <div class="s-hearts">ğŸ’¡ ğŸ† ğŸ’¡</div>
  <div class="s-title">WORLD 3-1</div>
  <div class="s-sub">ğŸ“ Enactus ERU â†’ ğŸ† The Competition</div>
  <div class="s-desc">
    Climb through your Enactus journey!<br>
    Dodge deadlines, exams & stress.<br>
    Collect ideas and reach the World Cup! ğŸ†
  </div>
  <div class="s-keys">
    <b>â† â†’</b> or <b>A / D</b> = Move Left / Right<br>
    <b>SPACE</b> or <b>â†‘</b> = Jump (double jump!)<br>
    ğŸ“± Tap buttons or swipe
  </div>
  <button class="s-btn" id="btnStart">ğŸ† BUILD!</button>
</div>

<div class="overlay go-bg" id="oGo">
  <div class="go-title">ğŸ’” BURNED OUT</div>
  <div class="go-sub">The competition won't wait...</div>
  <div class="go-score" id="goScore">0</div>
  <button class="go-btn" id="btnRetry">TRY AGAIN ğŸ’¡</button>
</div>

<div class="overlay story-bg" id="oStory">
  <div class="story-card">
    <div class="sc-head">ğŸ† WORLD 3-1 COMPLETE! ğŸ’•</div>
    <div class="sc-div"></div>
    <div class="sc-txt">
      <p>You made it to the World Cup stage together! What a journey...</p>
      <p class="ar">Ø¨Ø¹Ø¯ Ø¯Ù‡Ø¨ Ù…ÙƒÙ†Ø´ ÙÙŠ Ø§ÙŠ Ø­Ø§Ø¬Ø© ØªØ¬Ù…Ø¹Ù†Ø§ ÙØ§ Ù…ÙƒÙ†Ø´ ÙÙŠÙ‡ ØºÙŠØ± Ø­Ù„ ÙˆØ§Ø­Ø¯ Ø§Ù„ØªÙŠÙ… ÙƒØ§Ù† Ù„Ø§Ø²Ù… Ø§Ø®Ø´ Ø§ÙŠÙ†Ø§ÙƒØªØ³ Ø¹Ø´Ø§Ù† Ø§Ù„Ø§Ù‚ÙŠ Ø­Ø§Ø¬Ø© ØªØ®Ù„ÙŠÙ†ÙŠ Ø¯Ø§ÙŠÙ…Ø§ Ø¬Ù…Ø¨Ùƒ Ùˆ Ø±Ø¨Ù†Ø§ ÙƒØ§Ù† Ù…Ø³Ù‡Ù„Ù‡Ø§ Ø§Ù†ØªÙŠ ÙÙƒÙˆÙ…ÙŠØªÙŠ Ø§Ù†Ø§ Ø§Ø¹Ø±Ù Ø§Ø´ØªØºÙ„ ÙÙŠÙ‡ Ùˆ Ø§Ù„Ø¸Ø±ÙˆÙ  calls Ù†Ø±ØºÙŠ Ùˆ Ù‚Ø±Ø¨Ù†Ø§ Ù„Ø¨Ø¹Ø¶ Ø§ÙƒØªØ± Ùˆ Ø¨Ù‚ÙŠÙ†Ø§ Ù†Ø®Ø±Ø¬ ÙƒÙ„Ù†Ø§ Ø®Ø¯Ù…Øª Ùˆ Ø¨Ù‚ÙŠÙ†Ø§ Ù…Ø¹ Ø¨Ø¹Ø¶ Ø­ØªÙŠ Ù„Ù…Ø§ Ø¨Ù‚ÙŠØª Ø¯Ø§ÙŠØ±ÙƒØªÙˆØ± Ø¨Ø±Ø¶Ùˆ Ø¨Ù‚ÙŠØªÙŠ Ù…Ø¹Ø§ÙŠØ§ ÙÙ„ØªÙŠÙ… ÙØ§ Ø¨Ù‚ÙŠ Ø¨ÙŠÙ†Ø§ Ù…Ø¬Ø§Ù„Ø§Øª ÙƒÙ„Ø§Ù… ÙƒØªÙŠØ± Ùˆ Ù†Ù†Ø²Ù„ Ù†Ø¹Ù…Ù„ Ø¨Ø±ÙˆÙØ§Øª Ùˆ Ø¨Ù‚ÙŠÙ†Ø§ Ø¨Ù†ØªÙƒÙ„Ù… Ø¹Ù…ØªØ§ Ùˆ Ù†Ø®Ø´ </p>
    </div>
    <div class="sc-foot">
      <button class="btn-s btn-back" onclick="window.location.href='storybook.html'">â—€ MAP</button>
      <button class="btn-s btn-next" onclick="window.location.href='stage4.html'">WORLD 4 â–¶</button>
    </div>
  </div>
</div>

<div class="mob" id="mob">
  <div class="mb" id="mL">â—€</div>
  <div class="mb" id="mJ">â–²</div>
  <div class="mb" id="mR">â–¶</div>
</div>

<script>
(function(){

var canvas=document.getElementById('game');
var ctx=canvas.getContext('2d');
var W,H,scale;

function resize(){
  W=canvas.width=window.innerWidth;
  H=canvas.height=window.innerHeight;
  scale=Math.min(W/800,H/600);
}
resize();
window.addEventListener('resize',resize);

/* ============================================================
   GAME STATE
============================================================ */
var STATE='menu';
var height=0;
var maxHeight=4200;
var speed=1;
var baseSpeed=1;
var lives=3;
var ideas=0;
var invincible=0;
var frameCount=0;

/* ============================================================
   COLORS
============================================================ */
var C={
  bgColors:[
    {top:'#1A1040',bot:'#2A1860'},
    {top:'#2A2060',bot:'#3A2880'},
    {top:'#403080',bot:'#5040A0'},
    {top:'#6050B0',bot:'#8070D0'},
    {top:'#FFA040',bot:'#FFD080'},
  ],
  neonYellow:'#FFC107',neonOrange:'#FF8C00',neonBlue:'#4488FF',
  confetti:['#FF4080','#FFD700','#4488FF','#40FF80','#FF80FF','#00FFCC','#FF8040']
};

/* ============================================================
   BACKGROUND ELEMENTS
============================================================ */
var bgParticles=[];
for(var i=0;i<40;i++){
  bgParticles.push({
    x:Math.random()*2000,y:Math.random(),
    size:2+Math.random()*6,speed:0.2+Math.random()*0.6,
    drift:Math.random()*Math.PI*2,driftSpeed:0.01+Math.random()*0.02,
    opacity:0.05+Math.random()*0.15,
    type:['paper','code','dot'][Math.floor(Math.random()*3)]
  });
}

var stars=[];
for(var i=0;i<80;i++){
  stars.push({
    x:Math.random()*2000,y:Math.random()*0.6,
    size:0.5+Math.random()*2,
    twinkleSpeed:0.02+Math.random()*0.04,
    twinkleOffset:Math.random()*Math.PI*2,
    brightness:0.3+Math.random()*0.7
  });
}

var buildings=[];
for(var i=0;i<25;i++){
  buildings.push({
    x:i*100+Math.random()*30,
    w:50+Math.random()*70,h:60+Math.random()*120,
    windows:Math.floor(Math.random()*8)+2,
    hasAntenna:Math.random()>0.6
  });
}

var wallDecor=[];
for(var i=0;i<60;i++){
  wallDecor.push({
    y:i*100+Math.random()*50,
    side:Math.random()>0.5?'left':'right',
    type:['poster','board','banner','clock','screen'][Math.floor(Math.random()*5)],
    color:C.confetti[Math.floor(Math.random()*C.confetti.length)],
    w:15+Math.random()*25,h:15+Math.random()*25
  });
}

/* ============================================================
   PLAYER
============================================================ */
var player={x:0,y:0,w:30,h:50,vx:0,vy:0,jumping:false,grounded:false,runFrame:0};
var PLAYER_ACCEL=0.7;
var PLAYER_FRICTION=0.8;
var GRAVITY=0.28;
var JUMP_FORCE=-11.5;
var movingLeft=false;
var movingRight=false;
var airJumps=0;
var maxAirJumps=1;

function resetPlayer(){
  player.x=W/2-player.w/2;
  player.y=H*0.7;
  player.vx=0;player.vy=0;
  player.jumping=false;player.grounded=false;
  player.runFrame=0;airJumps=0;
}

/* ============================================================
   PLATFORMS
============================================================ */
var platforms=[];
var platSpawnTimer=0;
var lastSpawnX=0;

function spawnPlatform(){
  var wallW=26*scale;
  var pw=90+Math.random()*100;
  var dp=getHeightProgress();

  var minX=Math.max(wallW+5,lastSpawnX-130);
  var maxX=Math.min(W-wallW-pw-5,lastSpawnX+130);
  if(minX>maxX){minX=wallW+5;maxX=W-wallW-pw-5;}
  var px=minX+Math.random()*(maxX-minX);
  lastSpawnX=px;

  var pType='normal';
  var r=Math.random();
  if(r<0.12&&dp>0.25) pType='moving';
  else if(r<0.18&&dp>0.5) pType='crumble';
  else if(r<0.28&&dp>0.1) pType='boost';

  platforms.push({
    x:px,y:H+20,w:pw,h:10,
    type:pType,moveBaseX:px,
    moveRange:30+Math.random()*40,
    moveSpeed:0.015+Math.random()*0.01,
    moveOffset:Math.random()*Math.PI*2,
    crumbleTimer:45,crumbling:false,touched:false,
    color:pType==='boost'?'#40DD80':pType==='crumble'?'#FF8040':pType==='moving'?'#6080FF':'#5A50A0'
  });
}

function initPlatforms(){
  platforms=[];
  var wallW=26*scale;
  platforms.push({
    x:W/2-70,y:H*0.75,w:140,h:10,
    type:'normal',moveBaseX:W/2-70,moveRange:0,moveSpeed:0,moveOffset:0,
    crumbleTimer:45,crumbling:false,touched:false,color:'#5A50A0'
  });
  var lastX=W/2-70;
  for(var i=0;i<12;i++){
    var pw=90+Math.random()*100;
    var minX=Math.max(wallW+5,lastX-120);
    var maxX=Math.min(W-wallW-pw-5,lastX+120);
    if(minX>maxX) minX=maxX;
    var px=minX+Math.random()*(maxX-minX);
    var gap=45+Math.random()*15;
    platforms.push({
      x:px,y:H*0.75-(i+1)*gap,w:pw,h:10,
      type:'normal',moveBaseX:px,moveRange:0,moveSpeed:0,moveOffset:0,
      crumbleTimer:45,crumbling:false,touched:false,color:'#5A50A0'
    });
    lastX=px;
  }
  lastSpawnX=lastX;
}

/* ============================================================
   OBSTACLES
============================================================ */
var obstacles=[];
var obsSpawnTimer=0;

function spawnObstacle(){
  var dp=getHeightProgress();
  var r=Math.random();
  var margin=40;var playArea=W-margin*2;
  var obs;

  if(r<0.25){
    obs={x:margin+Math.random()*(playArea-30),y:H+20,w:30,h:30,
      type:'deadline',baseX:margin+Math.random()*(playArea-30),
      driftRange:20+Math.random()*30,driftSpeed:0.02+Math.random()*0.015,
      driftOffset:Math.random()*Math.PI*2};
  } else if(r<0.45){
    var fromLeft=Math.random()>0.5;
    obs={x:fromLeft?-40:W+10,y:H+20+Math.random()*50,w:35,h:28,
      type:'exam',horizSpeed:(2+Math.random()*2+dp*3)*(fromLeft?1:-1),fromLeft:fromLeft};
  } else if(r<0.65){
    obs={x:margin+Math.random()*(playArea-28),y:H+20,w:28,h:28,
      type:'stress',baseX:margin+Math.random()*(playArea-28),
      bounceSpeed:0.04+Math.random()*0.02,bounceOffset:Math.random()*Math.PI*2,
      bounceRange:15+Math.random()*20};
  } else if(r<0.80){
    var bx=margin+Math.random()*(playArea-24);
    obs={x:bx,y:H+20,w:24,h:20,type:'bug',baseX:bx,
      zigSpeed:0.05+Math.random()*0.03,zigRange:40+Math.random()*50,
      zigOffset:Math.random()*Math.PI*2};
  } else if(dp>0.3){
    var cw=50+Math.random()*60;
    obs={x:margin+Math.random()*(playArea-cw),y:H+20,w:cw,h:12,type:'coffee'};
  } else {
    obs={x:margin+Math.random()*(playArea-20),y:H+20,w:22,h:26,
      type:'paper',driftX:(Math.random()-0.5)*1.5,rot:0,rotSpeed:0.03+Math.random()*0.03};
  }
  obstacles.push(obs);
}

/* ============================================================
   COLLECTIBLES
============================================================ */
var collectibles=[];
var collectSpawnTimer=0;

function spawnCollectible(){
  var margin=50;var dp=getHeightProgress();
  var type='idea';var r=Math.random();
  if(r<0.6) type='idea';
  else if(r<0.8&&dp>0.2) type='teamMember';
  else if(dp>0.5) type='trophy';

  collectibles.push({
    x:margin+Math.random()*(W-margin*2),y:H+20,
    size:14,collected:false,type:type
  });
}

/* ============================================================
   PARTICLES
============================================================ */
var particles=[];

function emitCollectParticles(x,y,color){
  for(var i=0;i<10;i++){
    particles.push({x:x,y:y,vx:(Math.random()-0.5)*5,vy:-2-Math.random()*3,
      life:30+Math.random()*20,maxLife:50,size:3+Math.random()*4,
      type:'sparkle',color:color||'#FFC107'});
  }
}

function emitHitParticles(x,y){
  for(var i=0;i<12;i++){
    particles.push({x:x,y:y,vx:(Math.random()-0.5)*6,vy:(Math.random()-0.5)*4,
      life:20+Math.random()*15,maxLife:35,size:2+Math.random()*3,
      type:'hit',color:'#FF4060'});
  }
}

function spawnAmbientParticle(){
  var types=['paper','spark','dot'];
  var t=types[Math.floor(Math.random()*types.length)];
  particles.push({x:Math.random()*W,y:H+10,
    vx:(Math.random()-0.5)*1,vy:-0.5-Math.random()*1.5,
    life:120+Math.random()*80,maxLife:200,
    size:2+Math.random()*4,type:t,
    rot:Math.random()*Math.PI*2,rotSpeed:0.02+Math.random()*0.03,
    color:C.confetti[Math.floor(Math.random()*C.confetti.length)]
  });
}

/* ============================================================
   HELPERS
============================================================ */
function getHeightProgress(){return Math.min(height/maxHeight,1);}

function lerpColor(a,b,t){
  var ar=parseInt(a.slice(1,3),16),ag=parseInt(a.slice(3,5),16),ab=parseInt(a.slice(5,7),16);
  var br=parseInt(b.slice(1,3),16),bg=parseInt(b.slice(3,5),16),bb=parseInt(b.slice(5,7),16);
  var rr=Math.round(ar+(br-ar)*t),rg=Math.round(ag+(bg-ag)*t),rb=Math.round(ab+(bb-ab)*t);
  return '#'+((1<<24)+(rr<<16)+(rg<<8)+rb).toString(16).slice(1);
}

function getZoneColors(){
  var dp=getHeightProgress();
  var idx=Math.min(Math.floor(dp*4),3);
  var localT=(dp*4-idx);
  if(localT<0) localT=0;if(localT>1) localT=1;
  var c1=C.bgColors[idx];var c2=C.bgColors[Math.min(idx+1,4)];
  return{top:lerpColor(c1.top,c2.top,localT),bot:lerpColor(c1.bot,c2.bot,localT)};
}

/* ============================================================
   DRAWING FUNCTIONS
============================================================ */
function drawBackground(){
  var colors=getZoneColors();
  var grad=ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,colors.top);grad.addColorStop(1,colors.bot);
  ctx.fillStyle=grad;ctx.fillRect(0,0,W,H);
}

function drawStars(){
  var dp=getHeightProgress();
  if(dp>0.7) return;
  var fade=1-dp/0.7;
  for(var i=0;i<stars.length;i++){
    var s=stars[i];
    var sx=((s.x-height*0.01)%W+W)%W;
    var sy=s.y*H;
    var twinkle=0.4+0.6*Math.abs(Math.sin(frameCount*s.twinkleSpeed+s.twinkleOffset));
    ctx.globalAlpha=twinkle*s.brightness*fade;
    ctx.fillStyle='#FFF';ctx.beginPath();
    ctx.arc(sx,sy,s.size*scale,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;
}

function drawBuildings(){
  var dp=getHeightProgress();
  var scrollX=height*0.05;
  var alpha=dp<0.3?0.3:0.3-(dp-0.3)*0.5;
  if(alpha<=0) return;
  ctx.globalAlpha=Math.max(0,alpha);
  for(var i=0;i<buildings.length;i++){
    var b=buildings[i];
    var bx=((b.x*2-scrollX)%(25*100*2)+25*100*2)%(25*100*2)-100;
    var by=H-b.h*0.5*scale-20;
    var bw=b.w*0.6*scale;var bh=b.h*0.5*scale;
    ctx.fillStyle='#15102A';ctx.fillRect(bx,by,bw,bh+20);
    var ww=4*scale,wh=5*scale;
    for(var wi=0;wi<b.windows;wi++){
      var wx=bx+5+wi*(ww+4);
      if(wx>bx+bw-5) break;
      for(var wr=0;wr<Math.floor(bh/12);wr++){
        ctx.fillStyle=Math.random()>0.7?'#FFE080':'#0A0818';
        ctx.fillRect(wx,by+5+wr*(wh+4),ww,wh);
      }
    }
  }
  ctx.globalAlpha=1;
}

function drawWalls(){
  var scrollY=height*0.8;var dp=getHeightProgress();
  var wallColor;
  if(dp<0.25) wallColor='#201848';
  else if(dp<0.5) wallColor='#252060';
  else if(dp<0.75) wallColor='#302870';
  else wallColor='#483898';

  ctx.fillStyle=wallColor;
  ctx.fillRect(0,0,25*scale,H);
  ctx.fillRect(W-25*scale,0,25*scale,H);

  for(var i=0;i<wallDecor.length;i++){
    var d=wallDecor[i];
    var dy=((d.y-scrollY)%(60*100)+60*100)%(60*100)-100;
    if(dy<-50||dy>H+50) continue;
    var dx=d.side==='left'?3*scale:W-23*scale;
    if(d.type==='poster'){
      ctx.fillStyle=d.color;ctx.globalAlpha=0.4;
      ctx.fillRect(dx,dy,d.w*0.6*scale,d.h*0.7*scale);ctx.globalAlpha=1;
    } else if(d.type==='board'){
      ctx.fillStyle='#403060';ctx.globalAlpha=0.5;
      ctx.fillRect(dx,dy,d.w*0.7*scale,d.h*0.5*scale);
      ctx.fillStyle='#FFF';ctx.globalAlpha=0.15;
      ctx.fillRect(dx+2,dy+2,d.w*0.7*scale-4,d.h*0.5*scale-4);ctx.globalAlpha=1;
    } else if(d.type==='banner'){
      ctx.fillStyle=C.neonYellow;ctx.globalAlpha=0.25;
      ctx.fillRect(dx,dy,18*scale,6*scale);ctx.globalAlpha=1;
    } else if(d.type==='clock'){
      ctx.strokeStyle='rgba(255,255,255,0.15)';ctx.lineWidth=1;
      ctx.beginPath();ctx.arc(dx+8*scale,dy+8*scale,6*scale,0,Math.PI*2);ctx.stroke();
    } else if(d.type==='screen'){
      ctx.fillStyle='rgba(64,136,255,0.15)';
      ctx.fillRect(dx,dy,d.w*0.6*scale,d.h*0.4*scale);
    }
  }

  ctx.fillStyle='rgba(255,193,7,0.15)';
  ctx.fillRect(24*scale,0,2,H);
  ctx.fillRect(W-26*scale,0,2,H);
}

function drawBgParticles(){
  var scrollY=height*0.4;
  for(var i=0;i<bgParticles.length;i++){
    var p=bgParticles[i];
    var px=((p.x+Math.sin(frameCount*p.driftSpeed+p.drift)*20)%(W+100)+W+100)%(W+100)-50;
    var py=((p.y*H*4-scrollY*p.speed)%(H+200)+H+200)%(H+200)-50;
    ctx.globalAlpha=p.opacity;
    if(p.type==='paper'){
      ctx.fillStyle='rgba(255,255,255,0.3)';ctx.save();
      ctx.translate(px,py);ctx.rotate(frameCount*0.01+i);
      ctx.fillRect(-p.size/2,-p.size*0.7/2,p.size,p.size*0.7);ctx.restore();
    } else if(p.type==='code'){
      ctx.fillStyle='rgba(64,200,100,0.3)';
      ctx.font=(3*scale)+'px monospace';ctx.fillText('{}',px,py);
    } else {
      ctx.fillStyle='rgba(255,193,7,0.3)';ctx.beginPath();
      ctx.arc(px,py,p.size*0.5,0,Math.PI*2);ctx.fill();
    }
  }
  ctx.globalAlpha=1;
}

/* ============================================================
   DRAW PLATFORMS
============================================================ */
function drawPlatforms(){
  for(var i=0;i<platforms.length;i++){
    var p=platforms[i];
    if(p.crumbling&&p.crumbleTimer<=0) continue;
    ctx.globalAlpha=p.crumbling?p.crumbleTimer/45:1;
    var pGrad=ctx.createLinearGradient(p.x,p.y,p.x,p.y+p.h);
    pGrad.addColorStop(0,p.color);pGrad.addColorStop(1,'rgba(0,0,0,0.3)');
    ctx.fillStyle=pGrad;ctx.beginPath();ctx.roundRect(p.x,p.y,p.w,p.h,3);ctx.fill();
    ctx.fillStyle='rgba(255,255,255,0.15)';ctx.fillRect(p.x+2,p.y,p.w-4,2);

    if(p.type==='boost'){
      ctx.fillStyle='#FFF';ctx.globalAlpha=0.6*(p.crumbling?p.crumbleTimer/45:1);
      var ax=p.x+p.w/2;ctx.beginPath();
      ctx.moveTo(ax,p.y-4);ctx.lineTo(ax-5,p.y+2);ctx.lineTo(ax+5,p.y+2);ctx.closePath();ctx.fill();
    } else if(p.type==='moving'){
      ctx.fillStyle='rgba(255,255,255,0.3)';
      ctx.font=(5*scale)+'px sans-serif';ctx.textAlign='center';
      ctx.fillText('â†”',p.x+p.w/2,p.y-2);ctx.textAlign='left';
    } else if(p.type==='crumble'){
      ctx.strokeStyle='rgba(0,0,0,0.3)';ctx.lineWidth=1;
      ctx.beginPath();ctx.moveTo(p.x+p.w*0.3,p.y);ctx.lineTo(p.x+p.w*0.4,p.y+p.h);ctx.stroke();
      ctx.beginPath();ctx.moveTo(p.x+p.w*0.7,p.y);ctx.lineTo(p.x+p.w*0.6,p.y+p.h);ctx.stroke();
    }
    ctx.globalAlpha=1;
  }
}

/* ============================================================
   DRAW PLAYER
============================================================ */
function drawPlayer(){
  var px=player.x,py=player.y,pw=player.w,ph=player.h;
  if(invincible>0&&Math.floor(frameCount/4)%2===0) return;
  ctx.save();

  var legPhase=Math.sin(frameCount*0.3)*0.35;
  var armPhase=Math.sin(frameCount*0.3)*0.3;
  if(player.jumping){legPhase=0.3;armPhase=-0.4;}

  ctx.globalAlpha=0.25;ctx.fillStyle='#000';
  ctx.beginPath();ctx.ellipse(px+pw/2,py+ph+2,pw*0.5,3,0,0,Math.PI*2);ctx.fill();
  ctx.globalAlpha=1;

  // Legs
  ctx.save();ctx.translate(px+pw*0.32,py+ph*0.65);ctx.rotate(legPhase);
  ctx.fillStyle='#2A2060';ctx.fillRect(-3*scale,0,7*scale,ph*0.28);
  ctx.fillStyle='#1A1040';ctx.beginPath();ctx.roundRect(-4*scale,ph*0.25,9*scale,5*scale,2);ctx.fill();ctx.restore();

  ctx.save();ctx.translate(px+pw*0.68,py+ph*0.65);ctx.rotate(-legPhase);
  ctx.fillStyle='#2A2060';ctx.fillRect(-3*scale,0,7*scale,ph*0.28);
  ctx.fillStyle='#1A1040';ctx.beginPath();ctx.roundRect(-4*scale,ph*0.25,9*scale,5*scale,2);ctx.fill();ctx.restore();

  // Body
  ctx.fillStyle=C.neonYellow;ctx.beginPath();
  ctx.roundRect(px+pw*0.12,py+ph*0.3,pw*0.76,ph*0.38,4);ctx.fill();

  // Collar
  ctx.fillStyle='#E0A000';ctx.beginPath();
  ctx.moveTo(px+pw*0.35,py+ph*0.3);ctx.lineTo(px+pw*0.5,py+ph*0.38);
  ctx.lineTo(px+pw*0.65,py+ph*0.3);ctx.lineTo(px+pw*0.6,py+ph*0.28);
  ctx.lineTo(px+pw*0.5,py+ph*0.34);ctx.lineTo(px+pw*0.4,py+ph*0.28);ctx.closePath();ctx.fill();

  ctx.fillStyle='#C08000';ctx.font='bold '+(6*scale)+'px sans-serif';
  ctx.textAlign='center';ctx.fillText('E',px+pw*0.5,py+ph*0.55);ctx.textAlign='left';

  // Arms
  ctx.save();ctx.translate(px+pw*0.1,py+ph*0.34);ctx.rotate(-0.2+armPhase);
  ctx.fillStyle=C.neonYellow;ctx.fillRect(-3*scale,0,7*scale,ph*0.2);
  ctx.fillStyle='#FFB880';ctx.beginPath();ctx.arc(0,ph*0.22,3.5*scale,0,Math.PI*2);ctx.fill();ctx.restore();

  ctx.save();ctx.translate(px+pw*0.85,py+ph*0.34);ctx.rotate(0.2-armPhase);
  ctx.fillStyle=C.neonYellow;ctx.fillRect(-3*scale,0,7*scale,ph*0.2);
  ctx.fillStyle='#FFB880';ctx.beginPath();ctx.arc(0,ph*0.22,3.5*scale,0,Math.PI*2);ctx.fill();ctx.restore();

  // Head
  ctx.fillStyle='#FFB880';ctx.beginPath();
  ctx.arc(px+pw*0.5,py+ph*0.2,9*scale,0,Math.PI*2);ctx.fill();

  // Hair
  ctx.fillStyle='#3A2000';
  ctx.beginPath();ctx.arc(px+pw*0.5,py+ph*0.14,9*scale,Math.PI,Math.PI*2);ctx.fill();
  ctx.fillRect(px+pw*0.18,py+ph*0.12,4*scale,7*scale);
  ctx.fillRect(px+pw*0.72,py+ph*0.12,4*scale,7*scale);

  // Eyes
  ctx.fillStyle='#FFF';
  ctx.beginPath();ctx.ellipse(px+pw*0.38,py+ph*0.19,3*scale,3.5*scale,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(px+pw*0.62,py+ph*0.19,3*scale,3.5*scale,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#222';
  ctx.beginPath();ctx.arc(px+pw*0.4,py+ph*0.195,1.5*scale,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(px+pw*0.64,py+ph*0.195,1.5*scale,0,Math.PI*2);ctx.fill();

  // Smile
  ctx.strokeStyle='#C08060';ctx.lineWidth=1.5;
  ctx.beginPath();ctx.arc(px+pw*0.5,py+ph*0.22,4*scale,0.1*Math.PI,0.9*Math.PI);ctx.stroke();

  // Lanyard
  ctx.strokeStyle='#E83060';ctx.lineWidth=1.5;
  ctx.beginPath();ctx.moveTo(px+pw*0.4,py+ph*0.28);ctx.lineTo(px+pw*0.45,py+ph*0.42);ctx.stroke();
  ctx.beginPath();ctx.moveTo(px+pw*0.6,py+ph*0.28);ctx.lineTo(px+pw*0.55,py+ph*0.42);ctx.stroke();
  ctx.fillStyle='#E83060';ctx.beginPath();
  ctx.roundRect(px+pw*0.38,py+ph*0.42,pw*0.24,ph*0.08,2);ctx.fill();
  ctx.fillStyle='#FFF';ctx.font=(3*scale)+'px sans-serif';
  ctx.textAlign='center';ctx.fillText('ERU',px+pw*0.5,py+ph*0.48);ctx.textAlign='left';

  ctx.restore();
}

/* ============================================================
   DRAW OBSTACLES
============================================================ */
function drawObstacles(){
  for(var i=0;i<obstacles.length;i++){
    var o=obstacles[i];

    if(o.type==='deadline'){
      ctx.fillStyle='#FF2040';ctx.beginPath();
      ctx.arc(o.x+o.w/2,o.y+o.h/2,o.w*0.45,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#FFF';ctx.beginPath();
      ctx.arc(o.x+o.w/2,o.y+o.h/2,o.w*0.35,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='#FF2040';ctx.lineWidth=2;
      var angle1=frameCount*0.1+i;
      ctx.beginPath();ctx.moveTo(o.x+o.w/2,o.y+o.h/2);
      ctx.lineTo(o.x+o.w/2+Math.cos(angle1)*8,o.y+o.h/2+Math.sin(angle1)*8);ctx.stroke();
      ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(o.x+o.w/2,o.y+o.h/2);
      ctx.lineTo(o.x+o.w/2+Math.cos(angle1*3)*6,o.y+o.h/2+Math.sin(angle1*3)*6);ctx.stroke();
      ctx.shadowColor='#FF2040';ctx.shadowBlur=8;ctx.strokeStyle='#FF2040';ctx.lineWidth=1.5;
      ctx.beginPath();ctx.arc(o.x+o.w/2,o.y+o.h/2,o.w*0.45,0,Math.PI*2);ctx.stroke();
      ctx.shadowBlur=0;

    } else if(o.type==='exam'){
      ctx.fillStyle='#FFF8E0';ctx.save();
      ctx.translate(o.x+o.w/2,o.y+o.h/2);ctx.rotate(Math.sin(frameCount*0.05+i)*0.2);
      ctx.fillRect(-o.w/2,-o.h/2,o.w,o.h);
      ctx.strokeStyle='rgba(0,0,0,0.15)';ctx.lineWidth=1;
      for(var l=0;l<4;l++){ctx.beginPath();ctx.moveTo(-o.w/2+4,-o.h/2+6+l*5);
        ctx.lineTo(o.w/2-4,-o.h/2+6+l*5);ctx.stroke();}
      ctx.fillStyle='#FF2040';ctx.font='bold '+(8*scale)+'px sans-serif';
      ctx.textAlign='center';ctx.fillText('F',0,o.h*0.15);ctx.textAlign='left';ctx.restore();

    } else if(o.type==='stress'){
      var pulse=1+0.1*Math.sin(frameCount*0.15+i);
      ctx.fillStyle='#FF6020';ctx.beginPath();
      ctx.arc(o.x+o.w/2,o.y+o.h/2,o.w*0.4*pulse,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#FFF';
      ctx.beginPath();ctx.arc(o.x+o.w*0.37,o.y+o.h*0.4,2.5,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(o.x+o.w*0.63,o.y+o.h*0.4,2.5,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='#FFF';ctx.lineWidth=1.5;
      ctx.beginPath();ctx.arc(o.x+o.w/2,o.y+o.h*0.65,4,Math.PI,0);ctx.stroke();
      ctx.fillStyle='#60C0FF';ctx.beginPath();
      ctx.ellipse(o.x+o.w*0.75,o.y+o.h*0.3,2,3,0.3,0,Math.PI*2);ctx.fill();
      ctx.shadowColor='#FF6020';ctx.shadowBlur=10;ctx.globalAlpha=0.3;
      ctx.fillStyle='#FF6020';ctx.beginPath();
      ctx.arc(o.x+o.w/2,o.y+o.h/2,o.w*0.5,0,Math.PI*2);ctx.fill();
      ctx.shadowBlur=0;ctx.globalAlpha=1;

    } else if(o.type==='bug'){
      ctx.fillStyle='#40C040';
      ctx.beginPath();ctx.ellipse(o.x+o.w*0.3,o.y+o.h/2,5,6,0,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.ellipse(o.x+o.w*0.55,o.y+o.h/2,6,7,0,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.ellipse(o.x+o.w*0.78,o.y+o.h/2,5,5,0,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='#308030';ctx.lineWidth=1;
      for(var l=0;l<3;l++){
        var lx=o.x+o.w*0.25+l*o.w*0.25;
        ctx.beginPath();ctx.moveTo(lx,o.y+o.h/2);ctx.lineTo(lx-4,o.y+o.h*0.9);ctx.stroke();
        ctx.beginPath();ctx.moveTo(lx,o.y+o.h/2);ctx.lineTo(lx+4,o.y+o.h*0.1);ctx.stroke();
      }
      ctx.fillStyle='#FFF';ctx.beginPath();ctx.arc(o.x+o.w*0.15,o.y+o.h*0.35,2.5,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#000';ctx.beginPath();ctx.arc(o.x+o.w*0.14,o.y+o.h*0.35,1.2,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='#40C040';ctx.lineWidth=1;
      ctx.beginPath();ctx.moveTo(o.x+o.w*0.18,o.y+o.h*0.3);
      ctx.quadraticCurveTo(o.x+o.w*0.05,o.y+o.h*0.1,o.x,o.y);ctx.stroke();
      ctx.beginPath();ctx.moveTo(o.x+o.w*0.22,o.y+o.h*0.25);
      ctx.quadraticCurveTo(o.x+o.w*0.15,o.y+o.h*0.05,o.x+o.w*0.2,o.y-3);ctx.stroke();

    } else if(o.type==='coffee'){
      ctx.fillStyle='rgba(100,60,20,0.7)';ctx.beginPath();
      ctx.ellipse(o.x+o.w/2,o.y+o.h/2,o.w/2,o.h/2,0,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='rgba(140,80,30,0.5)';ctx.beginPath();
      ctx.ellipse(o.x+o.w*0.3,o.y+o.h*0.4,o.w*0.15,o.h*0.3,0.3,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='rgba(200,180,150,0.3)';ctx.lineWidth=1;
      for(var s=0;s<2;s++){var sx=o.x+o.w*0.3+s*o.w*0.4;
        ctx.beginPath();ctx.moveTo(sx,o.y);
        ctx.quadraticCurveTo(sx+Math.sin(frameCount*0.05+s)*5,o.y-8,sx+3,o.y-15);ctx.stroke();}

    } else if(o.type==='paper'){
      ctx.save();ctx.translate(o.x+o.w/2,o.y+o.h/2);ctx.rotate(o.rot);
      ctx.fillStyle='#FFF8E8';ctx.fillRect(-o.w/2,-o.h/2,o.w,o.h);
      ctx.strokeStyle='rgba(0,0,0,0.1)';ctx.lineWidth=0.5;
      for(var l=0;l<3;l++){ctx.beginPath();ctx.moveTo(-o.w/2+3,-o.h/2+5+l*6);
        ctx.lineTo(o.w/2-3,-o.h/2+5+l*6);ctx.stroke();}
      ctx.restore();
    }
  }
}

/* ============================================================
   DRAW COLLECTIBLES
============================================================ */
function drawCollectibles(){
  for(var i=0;i<collectibles.length;i++){
    var c=collectibles[i];
    if(c.collected) continue;
    var bob=Math.sin(frameCount*0.07+i*2)*4;var cy=c.y+bob;

    if(c.type==='idea'){
      ctx.shadowColor='#FFE040';ctx.shadowBlur=12;
      ctx.fillStyle='#FFE040';ctx.beginPath();
      ctx.arc(c.x,cy,c.size*scale*0.35,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
      ctx.fillStyle='#FFF8D0';ctx.beginPath();
      ctx.arc(c.x,cy-2,c.size*scale*0.28,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#C8A030';ctx.fillRect(c.x-3*scale,cy+c.size*0.2,6*scale,4*scale);
      ctx.strokeStyle='rgba(255,224,64,0.4)';ctx.lineWidth=1;
      for(var r=0;r<6;r++){var ra=(r/6)*Math.PI*2+frameCount*0.03;
        ctx.beginPath();ctx.moveTo(c.x+Math.cos(ra)*c.size*0.4,cy+Math.sin(ra)*c.size*0.4);
        ctx.lineTo(c.x+Math.cos(ra)*c.size*0.7,cy+Math.sin(ra)*c.size*0.7);ctx.stroke();}

    } else if(c.type==='teamMember'){
      ctx.fillStyle='#4488FF';ctx.beginPath();
      ctx.roundRect(c.x-5*scale,cy,10*scale,12*scale,3);ctx.fill();
      ctx.fillStyle='#FFB880';ctx.beginPath();ctx.arc(c.x,cy-4*scale,5*scale,0,Math.PI*2);ctx.fill();
      ctx.shadowColor='#4488FF';ctx.shadowBlur=8;
      ctx.strokeStyle='#4488FF';ctx.lineWidth=1;ctx.beginPath();
      ctx.arc(c.x,cy+2,c.size*scale*0.5,0,Math.PI*2);ctx.stroke();ctx.shadowBlur=0;

    } else if(c.type==='trophy'){
      ctx.shadowColor='#FFD700';ctx.shadowBlur=15;ctx.fillStyle='#FFD700';
      ctx.beginPath();ctx.moveTo(c.x-6*scale,cy-6*scale);ctx.lineTo(c.x+6*scale,cy-6*scale);
      ctx.lineTo(c.x+4*scale,cy+2*scale);ctx.lineTo(c.x-4*scale,cy+2*scale);ctx.closePath();ctx.fill();
      ctx.strokeStyle='#FFD700';ctx.lineWidth=2;
      ctx.beginPath();ctx.arc(c.x-7*scale,cy-2*scale,3*scale,0.5*Math.PI,1.5*Math.PI);ctx.stroke();
      ctx.beginPath();ctx.arc(c.x+7*scale,cy-2*scale,3*scale,1.5*Math.PI,0.5*Math.PI);ctx.stroke();
      ctx.fillRect(c.x-3*scale,cy+2*scale,6*scale,2*scale);
      ctx.fillRect(c.x-5*scale,cy+4*scale,10*scale,3*scale);ctx.shadowBlur=0;
      ctx.fillStyle='#FFF';ctx.font=(5*scale)+'px sans-serif';
      ctx.textAlign='center';ctx.fillText('â˜…',c.x,cy-1*scale);ctx.textAlign='left';
    }
  }
}

/* ============================================================
   DRAW PARTICLES
============================================================ */
function drawParticles(){
  for(var i=0;i<particles.length;i++){
    var p=particles[i];var alpha=p.life/p.maxLife;
    ctx.globalAlpha=alpha;
    if(p.type==='sparkle'){
      ctx.fillStyle=p.color;ctx.beginPath();
      ctx.arc(p.x,p.y,p.size*alpha,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle=p.color;ctx.lineWidth=0.5;ctx.beginPath();
      ctx.moveTo(p.x-p.size*1.5*alpha,p.y);ctx.lineTo(p.x+p.size*1.5*alpha,p.y);
      ctx.moveTo(p.x,p.y-p.size*1.5*alpha);ctx.lineTo(p.x,p.y+p.size*1.5*alpha);ctx.stroke();
    } else if(p.type==='hit'){
      ctx.fillStyle=p.color;ctx.fillRect(p.x-p.size/2,p.y-p.size/2,p.size,p.size);
    } else {
      ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot||0);
      ctx.fillStyle=p.color||'#FFC107';
      if(p.type==='paper') ctx.fillRect(-p.size/2,-p.size*0.6/2,p.size,p.size*0.6);
      else{ctx.beginPath();ctx.arc(0,0,p.size*0.5,0,Math.PI*2);ctx.fill();}
      ctx.restore();
    }
  }
  ctx.globalAlpha=1;
}

/* ============================================================
   DRAW HUD
============================================================ */
function drawHUD(){
  var barX=W*0.3,barY=12*scale,barW=W*0.4,barH=10*scale;
  ctx.fillStyle='rgba(255,255,255,0.08)';
  ctx.beginPath();ctx.roundRect(barX,barY,barW,barH,5);ctx.fill();

  var pct=Math.min(height/maxHeight,1);
  var fillGrad=ctx.createLinearGradient(barX,0,barX+barW,0);
  fillGrad.addColorStop(0,'#FFC107');fillGrad.addColorStop(0.5,'#FF8C00');fillGrad.addColorStop(1,'#FF4060');
  ctx.fillStyle=fillGrad;ctx.beginPath();ctx.roundRect(barX,barY,barW*pct,barH,5);ctx.fill();

  ctx.font=(8*scale)+'px sans-serif';
  ctx.fillText('ğŸ“',barX-18,barY+barH-1);
  ctx.fillText('ğŸ†',barX+barW+5,barY+barH-1);

  ctx.font=(14*scale)+'px sans-serif';
  for(var i=0;i<3;i++){
    ctx.globalAlpha=i<lives?1:0.2;
    ctx.fillText('â¤ï¸',W-80*scale+i*22*scale,22*scale);
  }
  ctx.globalAlpha=1;

  ctx.fillStyle='#B0A0D0';ctx.font=(7*scale)+'px "Press Start 2P"';
  ctx.textAlign='right';ctx.fillText('Floor '+Math.floor(height*0.02),W-12,40*scale);ctx.textAlign='left';

  if(ideas>0){ctx.fillStyle='#FFE040';ctx.font=(7*scale)+'px "Press Start 2P"';
    ctx.fillText('ğŸ’¡ x'+ideas,12,22*scale);}

  ctx.fillStyle='#FFC107';ctx.font=(7*scale)+'px "Press Start 2P"';
  ctx.fillText('WORLD 3-1',12,40*scale);

  var dp=getHeightProgress();var zone='',zoneCol='';
  if(dp<0.25){zone='FRESHMAN';zoneCol='#8080FF';}
  else if(dp<0.5){zone='TEAM BUILDING';zoneCol='#FFC107';}
  else if(dp<0.75){zone='NATIONALS';zoneCol='#FF8040';}
  else{zone='WORLD CUP';zoneCol='#FF4080';}

  ctx.fillStyle=zoneCol;ctx.globalAlpha=0.4+0.15*Math.sin(frameCount*0.05);
  ctx.font=(5*scale)+'px "Press Start 2P"';ctx.textAlign='center';
  ctx.fillText(zone,W/2,H-15*scale);ctx.textAlign='left';ctx.globalAlpha=1;
}

/* ============================================================
   BANNER
============================================================ */
var bannerTimer=0;var bannerText='';var bannerColor='';var lastZone=-1;

function checkZoneBanner(){
  var dp=getHeightProgress();var zone=Math.floor(dp*4);
  if(zone!==lastZone&&zone>0&&zone<=3){
    lastZone=zone;bannerTimer=120;
    if(zone===1){bannerText='ğŸ¢ TEAM BUILDING';bannerColor='#FFC107';}
    else if(zone===2){bannerText='ğŸ¤ NATIONALS';bannerColor='#FF8040';}
    else if(zone===3){bannerText='ğŸ† WORLD CUP';bannerColor='#FF4080';}
  }
}

function drawBanner(){
  if(bannerTimer<=0) return;bannerTimer--;
  var alpha=bannerTimer>100?((120-bannerTimer)/20):bannerTimer<30?(bannerTimer/30):1;
  ctx.globalAlpha=alpha*0.9;
  ctx.fillStyle='rgba(0,0,0,0.6)';ctx.fillRect(0,H*0.4,W,50*scale);
  ctx.fillStyle=bannerColor;ctx.font=(10*scale)+'px "Press Start 2P"';
  ctx.textAlign='center';ctx.shadowColor=bannerColor;ctx.shadowBlur=15;
  ctx.fillText(bannerText,W/2,H*0.4+32*scale);
  ctx.shadowBlur=0;ctx.textAlign='left';ctx.globalAlpha=1;
}

/* ============================================================
   GAME LOGIC
============================================================ */
function update(){
  if(STATE!=='playing') return;
  frameCount++;height++;

  var dp=getHeightProgress();
  speed=baseSpeed+dp*2;
  if(speed>3.5) speed=3.5;

  if(frameCount%12===0) spawnAmbientParticle();

  // Player movement
  if(movingLeft) player.vx-=PLAYER_ACCEL;
  if(movingRight) player.vx+=PLAYER_ACCEL;
  player.vx*=PLAYER_FRICTION;
  player.x+=player.vx;

  var wallW=26*scale;
  if(player.x<wallW){player.x=wallW;player.vx=0;}
  if(player.x+player.w>W-wallW){player.x=W-wallW-player.w;player.vx=0;}

  // Gravity
  player.vy+=GRAVITY;
  player.y+=player.vy;
  player.grounded=false;

    // Platform collision
  if(player.vy>=0){
    for(var i=0;i<platforms.length;i++){
      var p=platforms[i];
      if(p.crumbling&&p.crumbleTimer<=0) continue;
      var playerBottom=player.y+player.h;
      var prevBottom=playerBottom-player.vy;
      if(player.x+player.w>p.x+4&&player.x<p.x+p.w-4&&
         prevBottom<=p.y+4&&playerBottom>=p.y){
        player.y=p.y-player.h;player.vy=0;
        player.jumping=false;player.grounded=true;airJumps=0;
        if(p.type==='boost'&&!p.touched){
          player.vy=JUMP_FORCE*1.5;player.jumping=true;
          player.grounded=false;p.touched=true;
          emitCollectParticles(p.x+p.w/2,p.y,'#40DD80');
        }
        if(p.type==='crumble'&&!p.crumbling){
          p.crumbling=true;
        }
        break;
      }
    }
  }

  // Fall off screen = lose life
  if(player.y>H+50){
    lives--;
    invincible=60;
    emitHitParticles(player.x+player.w/2,H);
    worldE_shake();
    if(lives<=0){
      lives=0;STATE='over';
      document.getElementById('goScore').textContent='Floor '+Math.floor(height*0.02)+'  ğŸ’¡x'+ideas;
      setTimeout(function(){oGo.classList.add('show')},500);
      return;
    }
    // Respawn on nearest platform
    var bestPlat=null;var bestDist=99999;
    for(var i=0;i<platforms.length;i++){
      var p=platforms[i];
      if(p.crumbling&&p.crumbleTimer<=0) continue;
      if(p.y>10&&p.y<H*0.7){
        var d=Math.abs(p.y-H*0.5);
        if(d<bestDist){bestDist=d;bestPlat=p;}
      }
    }
    if(bestPlat){
      player.x=bestPlat.x+bestPlat.w/2-player.w/2;
      player.y=bestPlat.y-player.h;
    } else {
      player.x=W/2-player.w/2;player.y=H*0.5;
    }
    player.vy=0;player.vx=0;airJumps=0;
  }

  // Scroll everything down
  var scrollSpeed=speed;

  // Move platforms
  for(var i=platforms.length-1;i>=0;i--){
    var p=platforms[i];
    p.y+=scrollSpeed;

    if(p.type==='moving'){
      p.x=p.moveBaseX+Math.sin(frameCount*p.moveSpeed+p.moveOffset)*p.moveRange;
    }

    if(p.crumbling){
      p.crumbleTimer--;
      if(p.crumbleTimer<=0){
        if(player.grounded&&player.x+player.w>p.x&&player.x<p.x+p.w&&
           Math.abs((player.y+player.h)-p.y)<5){
          player.grounded=false;
        }
      }
    }

    if(p.y>H+50) platforms.splice(i,1);
  }

  // Spawn new platforms
  platSpawnTimer++;
  var platRate=Math.max(10,20-dp*8);
  if(platSpawnTimer>=platRate){
    platSpawnTimer=0;
    spawnPlatform();
  }

  // Ensure there's always reachable platforms
  var highestPlat=H;
  var lowestPlat=0;
  var platCount=0;
  for(var i=0;i<platforms.length;i++){
    var p=platforms[i];
    if(p.crumbling&&p.crumbleTimer<=0) continue;
    if(p.y>-20&&p.y<H+20){
      platCount++;
      if(p.y<highestPlat) highestPlat=p.y;
      if(p.y>lowestPlat) lowestPlat=p.y;
    }
  }

  // Always keep minimum 6 platforms on screen
  if(platCount<6||highestPlat>100){
    var wallW2=26*scale;
    for(var e=0;e<3;e++){
      var epw=90+Math.random()*100;
      var epx=Math.max(wallW2+5,lastSpawnX-100);
      var epxMax=Math.min(W-wallW2-epw-5,lastSpawnX+100);
      if(epx>epxMax) epx=wallW2+5;
      var ex=epx+Math.random()*(Math.max(1,epxMax-epx));
      platforms.push({
        x:ex,y:-10-e*50,w:epw,h:10,
        type:'normal',moveBaseX:ex,moveRange:0,moveSpeed:0,moveOffset:0,
        crumbleTimer:45,crumbling:false,touched:false,color:'#5A50A0'
      });
      lastSpawnX=ex;
    }
  }

  // Check for big vertical gaps and fill them
  var sortedPlats=[];
  for(var i=0;i<platforms.length;i++){
    var p=platforms[i];
    if(p.crumbling&&p.crumbleTimer<=0) continue;
    if(p.y>-20&&p.y<H+40) sortedPlats.push(p);
  }
  sortedPlats.sort(function(a,b){return a.y-b.y;});
  for(var i=1;i<sortedPlats.length;i++){
    var gap=sortedPlats[i].y-sortedPlats[i-1].y;
    if(gap>80){
      var fillY=sortedPlats[i-1].y+gap*0.5;
      var fillW=90+Math.random()*80;
      var wallW3=26*scale;
      var fillX=wallW3+10+Math.random()*(W-wallW3*2-fillW-20);
      platforms.push({
        x:fillX,y:fillY,w:fillW,h:10,
        type:'normal',moveBaseX:fillX,moveRange:0,moveSpeed:0,moveOffset:0,
        crumbleTimer:45,crumbling:false,touched:false,color:'#5A50A0'
      });
    }
  }

  // Obstacle spawning
  obsSpawnTimer++;
  var obsRate=Math.max(65,100-dp*30);
  if(obsSpawnTimer>=obsRate){
    obsSpawnTimer=0;
    spawnObstacle();
    if(dp>0.4&&Math.random()<0.15){
      setTimeout(function(){if(STATE==='playing') spawnObstacle();},400);
    }
  }

  // Move obstacles
  for(var i=obstacles.length-1;i>=0;i--){
    var o=obstacles[i];

    if(o.type==='exam'){
      o.x+=o.horizSpeed;o.y+=scrollSpeed*0.5;
      if((o.fromLeft&&o.x>W+60)||(!o.fromLeft&&o.x<-60)||o.y>H+60){
        obstacles.splice(i,1);continue;
      }
    } else if(o.type==='bug'){
      o.y+=scrollSpeed;
      o.x=o.baseX+Math.sin(frameCount*o.zigSpeed+o.zigOffset)*o.zigRange;
    } else if(o.type==='deadline'){
      o.y+=scrollSpeed;
      o.x=o.baseX+Math.sin(frameCount*o.driftSpeed+o.driftOffset)*o.driftRange;
    } else if(o.type==='stress'){
      o.y+=scrollSpeed;
      o.x=o.baseX+Math.sin(frameCount*o.bounceSpeed+o.bounceOffset)*o.bounceRange;
    } else if(o.type==='paper'){
      o.y+=scrollSpeed;o.x+=o.driftX;o.rot+=o.rotSpeed;
    } else {
      o.y+=scrollSpeed;
    }

    if(o.y>H+60){obstacles.splice(i,1);continue;}

    // Collision with player
    var px=player.x,py=player.y,pw=player.w,ph=player.h;
    var hitShrink=5;
    if(px+pw-hitShrink>o.x+hitShrink&&px+hitShrink<o.x+o.w-hitShrink&&
       py+ph-hitShrink>o.y+hitShrink&&py+hitShrink<o.y+o.h-hitShrink){
      if(invincible<=0){
        lives--;invincible=60;
        emitHitParticles(px+pw/2,py+ph/2);
        worldE_shake();
        if(lives<=0){
          lives=0;STATE='over';
          document.getElementById('goScore').textContent='Floor '+Math.floor(height*0.02)+'  ğŸ’¡x'+ideas;
          setTimeout(function(){oGo.classList.add('show')},500);
          return;
        }
      }
    }
  }

  // Move collectibles
  for(var i=collectibles.length-1;i>=0;i--){
    collectibles[i].y+=scrollSpeed;
    if(collectibles[i].y>H+50){collectibles.splice(i,1);continue;}

    var c=collectibles[i];
    if(!c.collected){
      if(player.x+player.w>c.x-c.size&&player.x<c.x+c.size&&
         player.y+player.h>c.y-c.size&&player.y<c.y+c.size*1.5){
        c.collected=true;ideas++;
        var col='#FFE040';
        if(c.type==='teamMember') col='#4488FF';
        if(c.type==='trophy') col='#FFD700';
        emitCollectParticles(c.x,c.y,col);
      }
    }
  }

  // Collectible spawning
  collectSpawnTimer++;
  if(collectSpawnTimer>=90+Math.random()*50){
    collectSpawnTimer=0;
    if(Math.random()>0.3) spawnCollectible();
  }

  // Update particles
  for(var i=particles.length-1;i>=0;i--){
    var p=particles[i];
    p.x+=(p.vx||0);p.y+=(p.vy||0)+scrollSpeed*0.3;
    p.life--;
    if(p.rot!==undefined) p.rot+=(p.rotSpeed||0);
    if(p.type==='sparkle') p.vy-=0.05;
    if(p.type==='hit'){p.vx*=0.94;p.vy*=0.94;}
    if(p.life<=0) particles.splice(i,1);
  }

  if(invincible>0) invincible--;

  // Win condition
  if(height>=maxHeight){
    STATE='won';
    showWinEffects();
    setTimeout(function(){showWinEffects();},1200);
    setTimeout(function(){oStory.classList.add('show');},3000);
    return;
  }
}

/* ============================================================
   CAMERA SHAKE
============================================================ */
var shakeAmount=0;
var shakeDuration=0;

function worldE_shake(){shakeAmount=6;shakeDuration=15;}

function getShakeOffset(){
  if(shakeDuration>0){
    shakeDuration--;
    var intensity=(shakeDuration/15)*shakeAmount;
    return{x:(Math.random()-0.5)*intensity*2,y:(Math.random()-0.5)*intensity*2};
  }
  return{x:0,y:0};
}

/* ============================================================
   WIN EFFECTS
============================================================ */
function showWinEffects(){
  for(var i=0;i<40;i++){
    (function(idx){
      setTimeout(function(){
        particles.push({
          x:W*0.15+Math.random()*W*0.7,y:H*0.2+Math.random()*H*0.4,
          vx:(Math.random()-0.5)*5,vy:-3-Math.random()*4,
          life:70+Math.random()*50,maxLife:120,
          size:4+Math.random()*6,type:'sparkle',
          color:C.confetti[Math.floor(Math.random()*C.confetti.length)]
        });
      },idx*50);
    })(i);
  }
  for(var i=0;i<20;i++){
    (function(idx){
      setTimeout(function(){
        particles.push({
          x:W*0.2+Math.random()*W*0.6,y:H*0.3+Math.random()*H*0.3,
          vx:(Math.random()-0.5)*3,vy:-1-Math.random()*2,
          life:80+Math.random()*40,maxLife:120,
          size:5+Math.random()*8,type:'paper',
          rot:Math.random()*Math.PI*2,rotSpeed:0.04+Math.random()*0.06,
          color:C.confetti[Math.floor(Math.random()*C.confetti.length)]
        });
      },idx*80);
    })(i);
  }
  for(var i=0;i<15;i++){
    (function(idx){
      setTimeout(function(){
        particles.push({
          x:W/2+(Math.random()-0.5)*100,y:H*0.4+(Math.random()-0.5)*60,
          vx:(Math.random()-0.5)*2,vy:-2-Math.random()*2,
          life:60+Math.random()*40,maxLife:100,
          size:3+Math.random()*5,type:'sparkle',color:'#FFD700'
        });
      },idx*100);
    })(i);
  }
}

/* ============================================================
   MAIN RENDER
============================================================ */
function render(){
  ctx.clearRect(0,0,W,H);
  var shake=getShakeOffset();
  ctx.save();ctx.translate(shake.x,shake.y);

  drawBackground();drawStars();drawBuildings();
  drawWalls();drawBgParticles();

  if(STATE==='playing'||STATE==='won'||STATE==='over'){
    drawPlatforms();drawObstacles();drawCollectibles();
    drawPlayer();drawParticles();drawBanner();drawHUD();
    checkZoneBanner();
  }

  ctx.restore();
}

/* ============================================================
   INPUT
============================================================ */
function doJump(){
  if(STATE!=='playing') return;
  if(player.grounded){
    player.jumping=true;player.grounded=false;
    player.vy=JUMP_FORCE;airJumps=0;
  } else if(airJumps<maxAirJumps){
    player.vy=JUMP_FORCE*0.8;airJumps++;
  }
}

function startMoveLeft(){movingLeft=true;}
function stopMoveLeft(){movingLeft=false;}
function startMoveRight(){movingRight=true;}
function stopMoveRight(){movingRight=false;}

document.addEventListener('keydown',function(e){
  if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A'){e.preventDefault();startMoveLeft();}
  if(e.key==='ArrowRight'||e.key==='d'||e.key==='D'){e.preventDefault();startMoveRight();}
  if(e.key===' '||e.key==='ArrowUp'||e.key==='w'||e.key==='W'){e.preventDefault();doJump();}
});
document.addEventListener('keyup',function(e){
  if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') stopMoveLeft();
  if(e.key==='ArrowRight'||e.key==='d'||e.key==='D') stopMoveRight();
});
window.addEventListener('keydown',function(e){if(e.key===' ') e.preventDefault();});

var mLb=document.getElementById('mL');
var mRb=document.getElementById('mR');
var mJb=document.getElementById('mJ');

mLb.addEventListener('touchstart',function(e){e.preventDefault();startMoveLeft();},{passive:false});
mLb.addEventListener('touchend',function(){stopMoveLeft();});
mLb.addEventListener('touchcancel',function(){stopMoveLeft();});
mLb.addEventListener('mousedown',function(){startMoveLeft();});
mLb.addEventListener('mouseup',function(){stopMoveLeft();});
mLb.addEventListener('mouseleave',function(){stopMoveLeft();});

mRb.addEventListener('touchstart',function(e){e.preventDefault();startMoveRight();},{passive:false});
mRb.addEventListener('touchend',function(){stopMoveRight();});
mRb.addEventListener('touchcancel',function(){stopMoveRight();});
mRb.addEventListener('mousedown',function(){startMoveRight();});
mRb.addEventListener('mouseup',function(){stopMoveRight();});
mRb.addEventListener('mouseleave',function(){stopMoveRight();});

mJb.addEventListener('touchstart',function(e){e.preventDefault();doJump();},{passive:false});
mJb.addEventListener('click',function(){doJump();});

var touchStartX=0,touchStartY=0;
document.addEventListener('touchstart',function(e){
  touchStartX=e.touches[0].clientX;touchStartY=e.touches[0].clientY;
},{passive:true});
document.addEventListener('touchmove',function(e){
  if(STATE!=='playing') return;
  var dx=e.touches[0].clientX-touchStartX;
  if(dx<-20){startMoveLeft();stopMoveRight();}
  else if(dx>20){startMoveRight();stopMoveLeft();}
  else{stopMoveLeft();stopMoveRight();}
},{passive:true});
document.addEventListener('touchend',function(e){
  if(STATE!=='playing') return;
  var dy=e.changedTouches[0].clientY-touchStartY;
  if(dy<-30) doJump();
  stopMoveLeft();stopMoveRight();
},{passive:true});

/* ============================================================
   OVERLAY REFERENCES
============================================================ */
var oStart=document.getElementById('oStart');
var oGo=document.getElementById('oGo');
var oStory=document.getElementById('oStory');

/* ============================================================
   START / RESTART
============================================================ */
function startGame(){
  oStart.classList.remove('show');
  oGo.classList.remove('show');
  oStory.classList.remove('show');

  if('ontouchstart' in window) document.getElementById('mob').classList.add('show');

  STATE='playing';
  height=0;speed=baseSpeed;lives=3;ideas=0;
  invincible=0;frameCount=0;
  obstacles=[];collectibles=[];particles=[];
  obsSpawnTimer=0;collectSpawnTimer=0;platSpawnTimer=0;
  shakeAmount=0;shakeDuration=0;
  movingLeft=false;movingRight=false;
  airJumps=0;lastSpawnX=W/2;
  bannerTimer=0;lastZone=-1;

  resize();resetPlayer();
  initPlatforms();
  invincible=30;
}

document.getElementById('btnStart').addEventListener('click',startGame);
document.getElementById('btnRetry').addEventListener('click',startGame);
document.addEventListener('contextmenu',function(e){e.preventDefault();});

/* ============================================================
   IDLE ANIMATION (menu)
============================================================ */
function idleLoop(){
  if(STATE==='menu'){
    frameCount++;height+=0.3;
    ctx.clearRect(0,0,W,H);
    drawBackground();drawStars();drawBuildings();
    drawWalls();drawBgParticles();

    if(frameCount%18===0) spawnAmbientParticle();
    for(var i=particles.length-1;i>=0;i--){
      var p=particles[i];
      p.x+=(p.vx||0);p.y+=(p.vy||0);p.life--;
      if(p.rot!==undefined) p.rot+=(p.rotSpeed||0);
      if(p.life<=0) particles.splice(i,1);
    }
    drawParticles();
  }
}

/* ============================================================
   MASTER LOOP
============================================================ */
function masterLoop(){
  if(STATE==='menu') idleLoop();
  else{update();render();}
  requestAnimationFrame(masterLoop);
}

resize();resetPlayer();masterLoop();

})();
</script>
</body>
</html>