<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>World 2-1: Blue Hole Dive</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#001020}
body{font-family:'Press Start 2P',cursive}
canvas{display:block;width:100vw;height:100vh}

.overlay{
  position:fixed;inset:0;z-index:100;
  display:none;align-items:center;justify-content:center;
  flex-direction:column;text-align:center;
}
.overlay.show{display:flex}

.start-bg{background:rgba(0,12,30,.94)}
.s-title{
  font-size:20px;color:#00E5FF;
  text-shadow:0 0 30px rgba(0,229,255,.4),0 0 60px rgba(0,229,255,.15),2px 2px 0 #000;
  margin-bottom:10px;
}
.s-sub{font-size:9px;color:#5090B0;margin-bottom:25px}
.s-desc{font-size:6.5px;color:#7AB0C8;line-height:2.8;margin-bottom:20px;max-width:340px}
.s-keys{
  font-size:6px;color:#5588AA;line-height:3;margin-bottom:30px;
  background:rgba(0,200,255,.04);padding:14px 20px;border-radius:8px;
  border:1px solid rgba(0,200,255,.1);
}
.s-keys b{color:#00E5FF}
.s-btn{
  font-family:'Press Start 2P',cursive;font-size:13px;
  color:#FFF;
  background:linear-gradient(180deg,#006B8F,#004466);
  border:none;border-radius:6px;padding:16px 50px;cursor:pointer;
  box-shadow:0 4px 0 #002838,0 0 25px rgba(0,180,220,.3);
  animation:btnGlow 2s ease-in-out infinite;
  transition:all .1s;pointer-events:auto;
}
.s-btn:hover{background:linear-gradient(180deg,#0088AA,#005577);transform:scale(1.04)}
.s-btn:active{transform:translateY(4px);box-shadow:0 0 0 #002838}
@keyframes btnGlow{
  0%,100%{box-shadow:0 4px 0 #002838,0 0 25px rgba(0,180,220,.3)}
  50%{box-shadow:0 4px 0 #002838,0 0 40px rgba(0,180,220,.5)}
}

.s-hearts{font-size:28px;margin-bottom:15px;letter-spacing:8px}

.go-bg{background:rgba(0,8,20,.93)}
.go-title{font-size:16px;color:#FF4060;margin-bottom:15px;text-shadow:0 0 15px rgba(255,64,96,.3)}
.go-sub{font-size:7px;color:#5588AA;margin-bottom:8px}
.go-score{font-size:9px;color:#00E5FF;margin-bottom:20px}
.go-btn{
  font-family:'Press Start 2P',cursive;font-size:10px;
  color:#FFF;background:linear-gradient(180deg,#006B8F,#004466);
  border:none;border-radius:5px;padding:13px 30px;cursor:pointer;
  box-shadow:0 4px 0 #002838;pointer-events:auto;
}
.go-btn:hover{background:linear-gradient(180deg,#0088AA,#005577)}
.go-btn:active{transform:translateY(4px);box-shadow:none}

.story-bg{background:rgba(0,6,18,.94)}
.story-card{
  width:620px;max-width:92vw;max-height:85vh;
  background:linear-gradient(180deg,#E8F6FF,#D0EEFF);
  border:4px solid #80C0E0;border-radius:12px;
  box-shadow:0 0 60px rgba(0,180,255,.15),inset 0 0 20px rgba(0,150,220,.1);
  padding:28px;overflow-y:auto;
  animation:cardIn .6s cubic-bezier(.34,1.56,.64,1);pointer-events:auto;
}
@keyframes cardIn{
  0%{transform:scale(0) rotate(180deg);opacity:0}
  60%{transform:scale(1.03) rotate(-2deg);opacity:1}
  100%{transform:scale(1) rotate(0);opacity:1}
}
.sc-head{font-size:11px;color:#006B8F;text-align:center;margin-bottom:12px}
.sc-div{width:100%;height:3px;background:linear-gradient(90deg,transparent,#80C0E0,transparent);margin-bottom:16px}
.sc-txt{font-size:10px;line-height:2.6;color:#305060}
.sc-txt p{margin-bottom:12px}
.sc-foot{
  display:flex;justify-content:space-between;margin-top:20px;
  padding-top:16px;border-top:1px solid #80C0E0;
}
.btn-s{
  font-family:'Press Start 2P',cursive;font-size:7px;
  padding:11px 18px;border-radius:5px;cursor:pointer;border:none;transition:all .12s;
}
.btn-back{color:#FFF;background:#888;box-shadow:0 3px 0 #555}
.btn-back:hover{background:#999}
.btn-back:active{transform:translateY(3px);box-shadow:none}
.btn-next{color:#FFF;background:#006B8F;box-shadow:0 3px 0 #003344}
.btn-next:hover{background:#0088AA}
.btn-next:active{transform:translateY(3px);box-shadow:none}

.mob{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  z-index:50;display:none;gap:20px;pointer-events:auto;
}
.mob.show{display:flex}
.mb{
  width:62px;height:62px;
  background:rgba(0,200,255,.1);border:2px solid rgba(0,200,255,.25);
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:22px;color:rgba(0,200,255,.6);cursor:pointer;
  -webkit-tap-highlight-color:transparent;user-select:none;
  backdrop-filter:blur(6px);
}
.mb:active{background:rgba(0,200,255,.3);color:#FFF}

.sc-txt p.ar{
  direction:rtl;
  text-align:center;
  font-size:14px;
  line-height:2;
  color:#305060;
}

@media(max-width:600px){
  .s-title{font-size:15px}
  .story-card{padding:18px}
  .sc-txt{font-size:8px}
  .sc-head{font-size:9px}
  .sc-txt p.ar{font-size:13px;line-height:3.5}
}
</style>
</head>
<body>

<canvas id="game"></canvas>

<div class="overlay start-bg show" id="oStart">
  <div class="s-hearts">ğŸ  ğŸŒŠ ğŸ </div>
  <div class="s-title">WORLD 2-1</div>
  <div class="s-sub">ğŸ¤¿ Blue Hole Dive â†’ ğŸ’ The Deep</div>
  <div class="s-desc">
    Dive into Dahab's legendary Blue Hole!<br>
    Dodge jellyfish, sharks, mines & coral.<br>
    Collect pearls on the way down! ğŸ’
  </div>
  <div class="s-keys">
    <b>â† â†’</b> or <b>A / D</b> = Move Left / Right<br>
    ğŸ“± Tap buttons or swipe
  </div>
  <button class="s-btn" id="btnStart">ğŸŒŠ DIVE!</button>
</div>

<div class="overlay go-bg" id="oGo">
  <div class="go-title">ğŸ’” OUT OF AIR</div>
  <div class="go-sub">The deep sea waits for no one...</div>
  <div class="go-score" id="goScore">0m</div>
  <button class="go-btn" id="btnRetry">TRY AGAIN ğŸŒŠ</button>
</div>

<div class="overlay story-bg" id="oStory">
  <div class="story-card">
    <div class="sc-head">ğŸ¤¿ WORLD 2-1 COMPLETE! ğŸ’•</div>
    <div class="sc-div"></div>
    <div class="sc-txt">
      <p>You reached the bottom of the Blue Hole in dahab i found love...</p>
      <p class="ar">ÙÙŠ Ø¯Ù‡Ø¨ Ù…ÙƒÙ†ØªØ´ Ø¨ÙÙƒØ± ÙØ§ÙŠ Ø­Ø§Ø¬Ø© ØºÙŠØ±Ùƒ ÙƒØ§Ù† Ù†ÙØ³ÙŠ Ø§ØªØ¹Ø±Ù Ø¹Ù„ÙŠÙƒÙŠ Ø¨Ø§ÙŠ Ø´ÙƒÙ„ Ø³Ø£Ù„Øª Ù…Ù†Ø¹Ù… Ø¹Ù„ÙŠÙƒÙŠ Ùˆ Ø§ØªØ§ÙƒØ¯Øª Ù…Ù†Ù‡ Ø§Ù„Ø§ÙˆÙ„ Ø§Ù† Ù…ÙÙŠØ´ Ø­Ø¯ ÙØ­ÙŠØ§ØªÙƒ Ùˆ Ø¨Ù‚ÙŠ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø§ØµØ¹Ø¨ Ù‡ØªØ¹Ø±Ù Ø¹Ù„ÙŠÙƒÙŠ Ø§Ø²Ø§ÙŠ Ùˆ Ø§Ù†ØªÙŠ Ø§ØµÙ„Ø§ Ù…ØªØ¹Ø±ÙÙŠÙ†ÙŠØ´ ÙƒÙ†Øª Ø®Ù„Ø§Øµ Ù‡Ù…ÙˆØª Ùˆ Ø§ÙƒÙ„Ù…Ùƒ Ø´ÙˆÙØª ÙÙŠÙƒÙŠ ÙƒÙ„ Ø§Ù„Ø­Ø¬Ø§Øª Ø§Ù„ÙŠ ÙƒØ§Ù† Ù†ÙØ³ÙŠ ÙÙŠÙ‡Ø§ Ù‚Ù…Ø± Ùˆ Ø±ÙˆØ­Ùƒ  Ø­Ù„ÙˆØ© Ùˆ Ø¨ØªØ¯ÙŠ ÙØ±Ø­Ø© Ù„Ù„Ù…ÙƒØ§Ù† Ù‚ÙˆÙ„Øª Ø¨Ø³ Ù‡Ø¹Ù…Ù„ Ø§ÙŠ Ø­Ø§Ø¬Ø© Ø¹Ø´Ø§Ù† Ø¹Ù„Ø§Ù‚Ù„ Ù†Ø±Ø¬Ø¹ Ù…Ù† Ø¯Ù‡Ø¨ ØµØ­Ø§Ø¨ Ùˆ Ù„Ø§Ø²Ù… Ø§ØªØ¹Ø±Ù Ø¹Ù„ÙŠ Ù…Ù„Ùƒ Ùˆ Ø§Ù„Ø§Ø¡ Ø¹Ø´Ø§Ù† Ø§Ø¹Ø±Ù Ø§Ø¨Ù‚ÙŠ Ù‚Ø±ÙŠØ¨ Ù…Ù†Ùƒ</p>
    </div>
    <div class="sc-foot">
      <button class="btn-s btn-back" onclick="window.location.href='storybook.html'">â—€ MAP</button>
      <button class="btn-s btn-next" onclick="window.location.href='stage3.html'">WORLD 3 â–¶</button>
    </div>
  </div>
</div>

<div class="mob" id="mob">
  <div class="mb" id="mL">â—€</div>
  <div class="mb" id="mR">â–¶</div>
</div>

<script>
(function(){

var canvas = document.getElementById('game');
var ctx = canvas.getContext('2d');
var W, H, scale;

function resize(){
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
  scale = Math.min(W/800, H/600);
}
resize();
window.addEventListener('resize', resize);

/* ============================================================
   GAME STATE
============================================================ */
var STATE = 'menu';
var depth = 0;
var maxDepth = 4500;       // â† WAY longer
var speed = 2.5;
var baseSpeed = 2.5;
var lives = 3;
var pearls = 0;
var invincible = 0;
var frameCount = 0;
var difficulty = 1;        // â† dynamic difficulty multiplier

/* ============================================================
   COLORS
============================================================ */
var C = {
  waterTop:'#0A3D5C', waterMid:'#062A44', waterDeep:'#021824', waterAbyss:'#010C14',
  coral1:'#FF6B6B', coral2:'#FF8E72', coral3:'#E84393', coral4:'#FDCB6E',
  coral5:'#6C5CE7', coral6:'#00B894',
  rock1:'#2D3436', rock2:'#3D4448',
  jellyPink:'#FF80C0', jellyBlue:'#60D0FF', jellyPurple:'#C080FF',
  pufferYellow:'#FFD866', pearlWhite:'#FFF8F0', pearlGlow:'#E0F0FF',
  bioGreen:'#00FFD5', bioBlue:'#40E0FF',
  diverSuit:'#1A2840', diverTank:'#8899AA', diverMask:'#FFE040',
  sharkGray:'#5A6670', sharkDark:'#3A4650',
  mineBlack:'#1A1A2A', mineRed:'#FF2040',
  eelGreen:'#30D080', eelDark:'#108040',
};

/* ============================================================
   BACKGROUND ELEMENTS
============================================================ */
var bubbles = [];
for(var i=0;i<60;i++){
  bubbles.push({
    x:Math.random()*2000, y:Math.random(),
    size:1+Math.random()*4, speed:0.3+Math.random()*0.8,
    drift:Math.random()*Math.PI*2, driftSpeed:0.01+Math.random()*0.02,
    opacity:0.1+Math.random()*0.25
  });
}

var coralSegments = [];
for(var i=0;i<80;i++){
  var coralColors = [C.coral1,C.coral2,C.coral3,C.coral4,C.coral5,C.coral6];
  var leftBumps=[], rightBumps=[];
  var numBumps = 2+Math.floor(Math.random()*4);
  for(var b=0;b<numBumps;b++){
    leftBumps.push({yOff:Math.random()*80, size:8+Math.random()*20,
      color:coralColors[Math.floor(Math.random()*coralColors.length)]});
    rightBumps.push({yOff:Math.random()*80, size:8+Math.random()*20,
      color:coralColors[Math.floor(Math.random()*coralColors.length)]});
  }
  coralSegments.push({
    y:i*90, leftW:20+Math.random()*70, rightW:20+Math.random()*70,
    leftColor:coralColors[Math.floor(Math.random()*coralColors.length)],
    rightColor:coralColors[Math.floor(Math.random()*coralColors.length)],
    leftBumps:leftBumps, rightBumps:rightBumps,
    hasSeaweedL:Math.random()>0.5, hasSeaweedR:Math.random()>0.5,
    seaweedColorL:coralColors[Math.floor(Math.random()*coralColors.length)],
    seaweedColorR:coralColors[Math.floor(Math.random()*coralColors.length)]
  });
}

var farRocks = [];
for(var i=0;i<40;i++){
  farRocks.push({y:i*120, leftW:40+Math.random()*100, rightW:40+Math.random()*100});
}

var bgFish = [];
for(var i=0;i<20;i++){
  var fishColors = ['#FF6B6B','#FDCB6E','#00B894','#74B9FF','#A29BFE','#FD79A8','#55EFC4','#FF9FF3'];
  bgFish.push({
    x:Math.random()*2000, y:Math.random(), size:3+Math.random()*8,
    speed:0.5+Math.random()*2, dir:Math.random()>0.5?1:-1,
    color:fishColors[Math.floor(Math.random()*fishColors.length)],
    tailPhase:Math.random()*Math.PI*2
  });
}

var lightRays = [];
for(var i=0;i<8;i++){
  lightRays.push({x:0.1+Math.random()*0.8, width:30+Math.random()*80,
    opacity:0.02+Math.random()*0.04, angle:-0.1+Math.random()*0.2});
}

/* ============================================================
   PLAYER
============================================================ */
var player = {x:0, y:0, w:34, h:52, vx:0, swimFrame:0};
var PLAYER_ACCEL = 0.6;
var PLAYER_FRICTION = 0.82;
var movingLeft = false;
var movingRight = false;

function resetPlayer(){
  player.x = W/2 - player.w/2;
  player.y = H*0.28;
  player.vx = 0;
  player.swimFrame = 0;
}

/* ============================================================
   OBSTACLES â€” 8 types now!
============================================================ */
var obstacles = [];
var obsSpawnTimer = 0;
var obsSpawnInterval = 75;   // â† faster base spawn

function spawnObstacle(){
  var dp = getDepthProgress();
  var r = Math.random();
  var obs;
  var margin = 50;
  var playArea = W - margin*2;

  // Deeper = harder obstacles unlock
  if(r < 0.22){
    // Jellyfish
    var jx = margin + Math.random()*(playArea-40);
    obs = {
      x:jx, y:H+20, w:36, h:44, type:'jellyfish',
      baseX:jx, driftRange:30+Math.random()*60,
      driftSpeed:0.02+Math.random()*0.025,
      driftOffset:Math.random()*Math.PI*2,
      color:[C.jellyPink,C.jellyBlue,C.jellyPurple][Math.floor(Math.random()*3)]
    };
  } else if(r < 0.36){
    // Sea urchin
    obs = {
      x:margin+Math.random()*(playArea-26), y:H+20, w:26, h:26, type:'urchin'
    };
  } else if(r < 0.50){
    // Coral block
    var fromLeft = Math.random()>0.5;
    var cw = 70+Math.random()*100;   // â† wider
    obs = {
      x:fromLeft?0:W-cw, y:H+20, w:cw, h:35, type:'coral_block',
      fromLeft:fromLeft,
      color:[C.coral1,C.coral2,C.coral3,C.coral4][Math.floor(Math.random()*4)]
    };
  } else if(r < 0.60){
    // Rock
    obs = {
      x:margin+Math.random()*(playArea-50), y:H+20, w:55, h:42, type:'rock'
    };
  } else if(r < 0.72){
    // Pufferfish
    var px2 = margin+Math.random()*(playArea-30);
    obs = {
      x:px2, y:H+20, w:30, h:28, type:'pufferfish',
      baseX:px2, driftRange:50+Math.random()*70,
      driftSpeed:0.035+Math.random()*0.025,
      driftOffset:Math.random()*Math.PI*2
    };
  } else if(r < 0.82 && dp > 0.15){
    // â˜… NEW: Sea mine â€” spiky danger ball
    obs = {
      x:margin+Math.random()*(playArea-40), y:H+20, w:40, h:40, type:'mine',
      baseX:margin+Math.random()*(playArea-40),
      driftRange:20+Math.random()*30,
      driftSpeed:0.015+Math.random()*0.01,
      driftOffset:Math.random()*Math.PI*2,
      chainLen:30+Math.random()*40
    };
  } else if(r < 0.92 && dp > 0.3){
    // â˜… NEW: Shark â€” fast horizontal crossing
    var fromL = Math.random()>0.5;
    obs = {
      x:fromL?-80:W+20, y:H+20, w:70, h:28, type:'shark',
      sharkSpeed:(3+Math.random()*3+dp*4)*(fromL?1:-1),
      fromLeft:fromL
    };
  } else if(dp > 0.5){
    // â˜… NEW: Electric eel â€” zigzag pattern
    var ex = margin+Math.random()*(playArea-30);
    obs = {
      x:ex, y:H+20, w:55, h:18, type:'eel',
      baseX:ex, zigSpeed:0.06+Math.random()*0.03,
      zigRange:60+Math.random()*80,
      zigOffset:Math.random()*Math.PI*2
    };
  } else {
    // Fallback: double jellyfish wave
    var jx1 = margin+Math.random()*(playArea*0.4);
    obs = {
      x:jx1, y:H+20, w:36, h:44, type:'jellyfish',
      baseX:jx1, driftRange:25+Math.random()*40,
      driftSpeed:0.02+Math.random()*0.02,
      driftOffset:Math.random()*Math.PI*2,
      color:[C.jellyPink,C.jellyBlue,C.jellyPurple][Math.floor(Math.random()*3)]
    };
    // Spawn second one on opposite side
    var jx2 = margin+playArea*0.5+Math.random()*(playArea*0.4);
    obstacles.push({
      x:jx2, y:H+40, w:36, h:44, type:'jellyfish',
      baseX:jx2, driftRange:25+Math.random()*40,
      driftSpeed:0.02+Math.random()*0.02,
      driftOffset:Math.random()*Math.PI*2+1,
      color:[C.jellyPink,C.jellyBlue,C.jellyPurple][Math.floor(Math.random()*3)]
    });
  }

  obstacles.push(obs);

    // â˜… COMBO SPAWNS â€” occasional double only
  if(dp > 0.4 && Math.random() < 0.15){
    setTimeout(function(){ if(STATE==='playing') spawnObstacle(); }, 400);
  }
  if(dp > 0.75 && Math.random() < 0.1){
    setTimeout(function(){ if(STATE==='playing') spawnObstacle(); }, 500);
  }
}

/* ============================================================
   WARNING SYSTEM â€” flash before sharks
============================================================ */
var warnings = [];

function addWarning(side, duration){
  warnings.push({side:side, life:duration, maxLife:duration});
}

/* ============================================================
   COLLECTIBLE PEARLS
============================================================ */
var collectPearls = [];
var pearlSpawnTimer = 0;

function spawnPearl(){
  var margin = 60;
  collectPearls.push({
    x:margin+Math.random()*(W-margin*2), y:H+20,
    size:12, collected:false, sparkle:0
  });
}

/* ============================================================
   PARTICLES
============================================================ */
var particles = [];

function emitPearlCollect(x,y){
  for(var i=0;i<10;i++){
    particles.push({
      x:x,y:y, vx:(Math.random()-0.5)*4, vy:-1-Math.random()*3,
      life:30+Math.random()*20, maxLife:50, size:3+Math.random()*4,
      type:'sparkle', color:Math.random()>0.5?'#E0F0FF':'#FFD700'
    });
  }
}

function emitHitParticles(x,y){
  for(var i=0;i<12;i++){
    particles.push({
      x:x,y:y, vx:(Math.random()-0.5)*6, vy:(Math.random()-0.5)*4,
      life:20+Math.random()*15, maxLife:35, size:2+Math.random()*3,
      type:'hit', color:'#FF4060'
    });
  }
}

function spawnBubbleParticle(){
  particles.push({
    x:Math.random()*W, y:H+10,
    vx:(Math.random()-0.5)*0.5, vy:-1-Math.random()*2,
    life:150+Math.random()*100, maxLife:250,
    size:2+Math.random()*5, type:'bubble',
    wobble:Math.random()*Math.PI*2, wobbleSpeed:0.03+Math.random()*0.03
  });
}

function spawnPlayerBubble(){
  particles.push({
    x:player.x+player.w/2+(Math.random()-0.5)*8, y:player.y-2,
    vx:(Math.random()-0.5)*1, vy:-1.5-Math.random()*1.5,
    life:40+Math.random()*30, maxLife:70,
    size:1.5+Math.random()*3, type:'bubble',
    wobble:Math.random()*Math.PI*2, wobbleSpeed:0.05+Math.random()*0.04
  });
}

/* ============================================================
   HELPER
============================================================ */
function getDepthProgress(){ return Math.min(depth/maxDepth,1); }

function lerpColor(a,b,t){
  var ar=parseInt(a.slice(1,3),16),ag=parseInt(a.slice(3,5),16),ab=parseInt(a.slice(5,7),16);
  var br=parseInt(b.slice(1,3),16),bg=parseInt(b.slice(3,5),16),bb=parseInt(b.slice(5,7),16);
  var rr=Math.round(ar+(br-ar)*t),rg=Math.round(ag+(bg-ag)*t),rb=Math.round(ab+(bb-ab)*t);
  return '#'+((1<<24)+(rr<<16)+(rg<<8)+rb).toString(16).slice(1);
}

/* ============================================================
   DRAWING FUNCTIONS
============================================================ */
function drawWater(){
  var dp = getDepthProgress();
  var topCol,botCol;
  if(dp<0.5){
    topCol=lerpColor('#0A3D5C','#062A44',dp*2);
    botCol=lerpColor('#062A44','#021824',dp*2);
  } else {
    topCol=lerpColor('#062A44','#010C14',(dp-0.5)*2);
    botCol=lerpColor('#021824','#010810',(dp-0.5)*2);
  }
  var grad=ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,topCol); grad.addColorStop(1,botCol);
  ctx.fillStyle=grad; ctx.fillRect(0,0,W,H);
}

function drawLightRays(){
  var dp=getDepthProgress();
  if(dp>0.7) return;
  var fade=1-dp/0.7;
  for(var i=0;i<lightRays.length;i++){
    var ray=lightRays[i];
    var rx=ray.x*W+Math.sin(frameCount*0.005+i)*30;
    ctx.save(); ctx.translate(rx,0); ctx.rotate(ray.angle);
    ctx.globalAlpha=ray.opacity*fade*(0.6+0.4*Math.sin(frameCount*0.02+i*1.5));
    var rGrad=ctx.createLinearGradient(0,0,0,H*0.8);
    rGrad.addColorStop(0,'rgba(120,220,255,0.15)');
    rGrad.addColorStop(0.5,'rgba(80,180,220,0.05)');
    rGrad.addColorStop(1,'rgba(40,100,150,0)');
    ctx.fillStyle=rGrad; ctx.fillRect(-ray.width/2,0,ray.width,H*0.8);
    ctx.restore();
  }
  ctx.globalAlpha=1;
}

function drawCaustics(){
  var dp=getDepthProgress();
  if(dp>0.5) return;
  var fade=1-dp/0.5;
  ctx.globalAlpha=0.03*fade;
  var scrollY=depth*0.3;
  for(var cx=0;cx<W;cx+=60){
    for(var cy=0;cy<H;cy+=60){
      var wave=Math.sin(cx*0.03+frameCount*0.03)*Math.cos(cy*0.03-frameCount*0.02+scrollY*0.01);
      if(wave>0.3){
        ctx.fillStyle='rgba(150,230,255,'+(wave*0.3*fade)+')';
        ctx.beginPath();
        ctx.ellipse(cx+wave*20,cy+wave*15,15+wave*10,10+wave*8,wave,0,Math.PI*2);
        ctx.fill();
      }
    }
  }
  ctx.globalAlpha=1;
}

function drawFarRocks(){
  var scrollY=depth*0.3;
  ctx.fillStyle='#0A1820';
  for(var i=0;i<farRocks.length;i++){
    var fr=farRocks[i];
    var fy=((fr.y-scrollY)%(40*120)+40*120)%(40*120)-120;
    ctx.beginPath();ctx.moveTo(0,fy);
    ctx.lineTo(fr.leftW*0.6*scale,fy+20);ctx.lineTo(fr.leftW*0.7*scale,fy+60);
    ctx.lineTo(fr.leftW*0.4*scale,fy+100);ctx.lineTo(0,fy+120);ctx.fill();
    ctx.beginPath();ctx.moveTo(W,fy);
    ctx.lineTo(W-fr.rightW*0.6*scale,fy+25);ctx.lineTo(W-fr.rightW*0.7*scale,fy+55);
    ctx.lineTo(W-fr.rightW*0.4*scale,fy+95);ctx.lineTo(W,fy+120);ctx.fill();
  }
}

function drawCoralWalls(){
  var scrollY=depth*0.8;
  for(var i=0;i<coralSegments.length;i++){
    var cs=coralSegments[i];
    var cy=((cs.y-scrollY)%(80*90)+80*90)%(80*90)-90;
    if(cy<-100||cy>H+100) continue;
    ctx.fillStyle=cs.leftColor; ctx.globalAlpha=0.7;
    ctx.beginPath();ctx.moveTo(0,cy);
    ctx.quadraticCurveTo(cs.leftW*0.8*scale,cy+20,cs.leftW*0.5*scale,cy+45);
    ctx.quadraticCurveTo(cs.leftW*0.6*scale,cy+70,0,cy+90);ctx.fill();
    for(var b=0;b<cs.leftBumps.length;b++){
      var bump=cs.leftBumps[b];ctx.fillStyle=bump.color;
      ctx.beginPath();ctx.arc(bump.size*0.3*scale,cy+bump.yOff,bump.size*scale*0.4,0,Math.PI*2);ctx.fill();
    }
    if(cs.hasSeaweedL){
      ctx.strokeStyle=cs.seaweedColorL;ctx.lineWidth=2;ctx.globalAlpha=0.5;
      var swx=cs.leftW*0.4*scale;
      ctx.beginPath();ctx.moveTo(swx,cy+30);
      ctx.quadraticCurveTo(swx+Math.sin(frameCount*0.04+i)*12,cy+10,swx+8,cy-10);ctx.stroke();
    }
    ctx.globalAlpha=0.7;ctx.fillStyle=cs.rightColor;
    ctx.beginPath();ctx.moveTo(W,cy);
    ctx.quadraticCurveTo(W-cs.rightW*0.8*scale,cy+25,W-cs.rightW*0.5*scale,cy+45);
    ctx.quadraticCurveTo(W-cs.rightW*0.6*scale,cy+65,W,cy+90);ctx.fill();
    for(var b=0;b<cs.rightBumps.length;b++){
      var bump=cs.rightBumps[b];ctx.fillStyle=bump.color;
      ctx.beginPath();ctx.arc(W-bump.size*0.3*scale,cy+bump.yOff,bump.size*scale*0.4,0,Math.PI*2);ctx.fill();
    }
    if(cs.hasSeaweedR){
      ctx.strokeStyle=cs.seaweedColorR;ctx.lineWidth=2;ctx.globalAlpha=0.5;
      var swxR=W-cs.rightW*0.4*scale;
      ctx.beginPath();ctx.moveTo(swxR,cy+30);
      ctx.quadraticCurveTo(swxR-Math.sin(frameCount*0.04+i+2)*12,cy+10,swxR-8,cy-10);ctx.stroke();
    }
    ctx.globalAlpha=1;
  }
}

function drawBgFish(){
  var scrollY=depth*0.5;
  for(var i=0;i<bgFish.length;i++){
    var f=bgFish[i];
    var fx=f.x+f.dir*frameCount*f.speed*0.3;
    fx=((fx%(W+200))+W+200)%(W+200)-100;
    var fy=((f.y*H*3-scrollY*0.4+i*80)%(H+200)+H+200)%(H+200)-50;
    var tailWag=Math.sin(frameCount*0.15+f.tailPhase)*0.3;
    ctx.globalAlpha=0.35;ctx.save();ctx.translate(fx,fy);ctx.scale(f.dir,1);
    ctx.fillStyle=f.color;ctx.beginPath();
    ctx.ellipse(0,0,f.size*1.5,f.size*0.8,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.moveTo(-f.size*1.2,0);
    ctx.lineTo(-f.size*2.2,-f.size*0.8+tailWag*f.size);
    ctx.lineTo(-f.size*2.2,f.size*0.8+tailWag*f.size);ctx.closePath();ctx.fill();
    ctx.fillStyle='#FFF';ctx.beginPath();
    ctx.arc(f.size*0.6,-f.size*0.15,f.size*0.25,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#000';ctx.beginPath();
    ctx.arc(f.size*0.7,-f.size*0.15,f.size*0.12,0,Math.PI*2);ctx.fill();
    ctx.restore();ctx.globalAlpha=1;
  }
}

function drawBgBubbles(){
  for(var i=0;i<bubbles.length;i++){
    var b=bubbles[i];
    var bx=((b.x+Math.sin(frameCount*b.driftSpeed+b.drift)*20-depth*0.1)%(W+100)+W+100)%(W+100)-50;
    var by=((b.y*H*3-depth*b.speed*0.3)%(H+200)+H+200)%(H+200)-50;
    ctx.globalAlpha=b.opacity;
    ctx.strokeStyle='rgba(180,230,255,0.5)';ctx.lineWidth=1;
    ctx.beginPath();ctx.arc(bx,by,b.size*scale,0,Math.PI*2);ctx.stroke();
    ctx.fillStyle='rgba(220,250,255,0.2)';ctx.beginPath();
    ctx.arc(bx-b.size*0.25,by-b.size*0.25,b.size*0.35*scale,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;
}

function drawBioluminescence(){
  var dp=getDepthProgress();
  if(dp<0.4) return;
  var intensity=(dp-0.4)/0.6;
  ctx.globalAlpha=intensity*0.5;
  for(var i=0;i<20;i++){
    var bx=((i*137.5+Math.sin(frameCount*0.01+i*2)*50+depth*0.05)%W+W)%W;
    var by=((i*89.3+Math.cos(frameCount*0.015+i)*40-depth*0.3)%H+H)%H;
    var pulse=0.5+0.5*Math.sin(frameCount*0.05+i*1.3);
    var sz=(2+pulse*3)*scale;
    var bioCol=i%2===0?C.bioGreen:C.bioBlue;
    ctx.shadowColor=bioCol;ctx.shadowBlur=10*pulse;
    ctx.fillStyle=bioCol;ctx.beginPath();ctx.arc(bx,by,sz,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;
  }
  ctx.globalAlpha=1;
}

function drawSurface(){
  if(depth>300) return;
  var fade=1-depth/300;
  ctx.globalAlpha=fade*0.3;
  ctx.fillStyle='rgba(120,220,255,0.2)';
  ctx.beginPath();ctx.moveTo(0,0);
  for(var sx=0;sx<=W;sx+=20){
    var sy=15+Math.sin(sx*0.02+frameCount*0.05)*8+Math.sin(sx*0.01-frameCount*0.03)*5;
    ctx.lineTo(sx,sy);
  }
  ctx.lineTo(W,0);ctx.fill();ctx.globalAlpha=1;
}

/* ============================================================
   DRAW PLAYER (Diver)
============================================================ */
function drawPlayer(){
  var px=player.x,py=player.y,pw=player.w,ph=player.h;
  if(invincible>0&&Math.floor(frameCount/4)%2===0) return;
  ctx.save();
  var legKick=Math.sin(frameCount*0.2)*0.3;
  var armSwim=Math.sin(frameCount*0.12)*0.25;

  ctx.globalAlpha=0.15;ctx.fillStyle='#00CCFF';
  ctx.beginPath();ctx.ellipse(px+pw/2,py+ph+5,pw*0.7,5,0,0,Math.PI*2);ctx.fill();
  ctx.globalAlpha=1;

  // Legs/fins
  ctx.save();ctx.translate(px+pw*0.35,py+ph*0.85);ctx.rotate(legKick*0.4);
  ctx.fillStyle='#0D2035';ctx.beginPath();ctx.moveTo(0,0);
  ctx.lineTo(-6*scale,14*scale);ctx.lineTo(8*scale,14*scale);ctx.closePath();ctx.fill();
  ctx.fillStyle='#00AACC';ctx.beginPath();ctx.moveTo(-6*scale,14*scale);
  ctx.lineTo(-12*scale,20*scale);ctx.lineTo(10*scale,18*scale);
  ctx.lineTo(8*scale,14*scale);ctx.closePath();ctx.fill();ctx.restore();

  ctx.save();ctx.translate(px+pw*0.65,py+ph*0.85);ctx.rotate(-legKick*0.4);
  ctx.fillStyle='#0D2035';ctx.beginPath();ctx.moveTo(0,0);
  ctx.lineTo(-6*scale,14*scale);ctx.lineTo(8*scale,14*scale);ctx.closePath();ctx.fill();
  ctx.fillStyle='#00AACC';ctx.beginPath();ctx.moveTo(-6*scale,14*scale);
  ctx.lineTo(-12*scale,20*scale);ctx.lineTo(10*scale,18*scale);
  ctx.lineTo(8*scale,14*scale);ctx.closePath();ctx.fill();ctx.restore();

  // Body
  ctx.fillStyle=C.diverSuit;ctx.beginPath();
  ctx.roundRect(px+pw*0.15,py+ph*0.3,pw*0.7,ph*0.55,5);ctx.fill();
  ctx.fillStyle='#1A4060';ctx.fillRect(px+pw*0.35,py+ph*0.32,pw*0.3,ph*0.5);

  // Tank
  ctx.fillStyle=C.diverTank;ctx.beginPath();
  ctx.roundRect(px+pw*0.7,py+ph*0.2,pw*0.22,ph*0.45,4);ctx.fill();
  ctx.fillStyle='#667788';ctx.beginPath();
  ctx.roundRect(px+pw*0.72,py+ph*0.16,pw*0.18,ph*0.08,3);ctx.fill();
  ctx.fillStyle='#AAB8C8';ctx.fillRect(px+pw*0.78,py+ph*0.12,pw*0.06,ph*0.06);

  // Arms
  ctx.save();ctx.translate(px+pw*0.15,py+ph*0.38);ctx.rotate(-0.3+armSwim);
  ctx.fillStyle=C.diverSuit;ctx.fillRect(-3*scale,0,7*scale,ph*0.22);
  ctx.fillStyle='#0D2035';ctx.beginPath();ctx.arc(0,ph*0.25,4*scale,0,Math.PI*2);ctx.fill();
  ctx.restore();

  ctx.save();ctx.translate(px+pw*0.75,py+ph*0.38);ctx.rotate(0.3-armSwim);
  ctx.fillStyle=C.diverSuit;ctx.fillRect(-3*scale,0,7*scale,ph*0.22);
  ctx.fillStyle='#0D2035';ctx.beginPath();ctx.arc(0,ph*0.25,4*scale,0,Math.PI*2);ctx.fill();
  ctx.restore();

  // Head
  ctx.fillStyle='#0D2035';ctx.beginPath();
  ctx.arc(px+pw*0.5,py+ph*0.2,10*scale,0,Math.PI*2);ctx.fill();

  // Mask
  ctx.fillStyle=C.diverMask;ctx.shadowColor='rgba(255,224,64,0.3)';ctx.shadowBlur=6;
  ctx.beginPath();ctx.roundRect(px+pw*0.25,py+ph*0.12,pw*0.5,ph*0.14,4);ctx.fill();
  ctx.shadowBlur=0;

  ctx.fillStyle='rgba(100,180,220,0.6)';
  ctx.beginPath();ctx.roundRect(px+pw*0.28,py+ph*0.135,pw*0.2,ph*0.1,2);ctx.fill();
  ctx.beginPath();ctx.roundRect(px+pw*0.52,py+ph*0.135,pw*0.2,ph*0.1,2);ctx.fill();

  ctx.fillStyle='#FFF';
  ctx.beginPath();ctx.arc(px+pw*0.38,py+ph*0.175,2.5*scale,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(px+pw*0.62,py+ph*0.175,2.5*scale,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#222';
  ctx.beginPath();ctx.arc(px+pw*0.38,py+ph*0.175,1.3*scale,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(px+pw*0.62,py+ph*0.175,1.3*scale,0,Math.PI*2);ctx.fill();

  ctx.fillStyle='#333';ctx.fillRect(px+pw*0.4,py+ph*0.26,pw*0.2,3*scale);
  ctx.fillStyle='#555';ctx.beginPath();ctx.arc(px+pw*0.5,py+ph*0.28,3*scale,0,Math.PI*2);ctx.fill();

  if(frameCount%12===0) spawnPlayerBubble();
  ctx.restore();
}

/* ============================================================
   DRAW OBSTACLES â€” all 8 types
============================================================ */
function drawObstacles(){
  for(var i=0;i<obstacles.length;i++){
    var o=obstacles[i];

    if(o.type==='jellyfish'){
      ctx.globalAlpha=0.7;
      var jGrad=ctx.createRadialGradient(o.x+o.w/2,o.y+o.h*0.3,2,o.x+o.w/2,o.y+o.h*0.3,o.w*0.6);
      jGrad.addColorStop(0,'rgba(255,255,255,0.5)');jGrad.addColorStop(1,o.color);
      ctx.fillStyle=jGrad;
      ctx.beginPath();ctx.ellipse(o.x+o.w/2,o.y+o.h*0.3,o.w*0.5,o.h*0.35,0,Math.PI,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.ellipse(o.x+o.w/2,o.y+o.h*0.3,o.w*0.5,o.h*0.3,0,0,Math.PI);ctx.fill();
      ctx.fillStyle='rgba(255,255,255,0.15)';
      ctx.beginPath();ctx.ellipse(o.x+o.w/2,o.y+o.h*0.25,o.w*0.25,o.h*0.15,0,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle=o.color;ctx.lineWidth=1.5;ctx.globalAlpha=0.5;
      for(var t=0;t<5;t++){
        var tx=o.x+o.w*0.2+t*(o.w*0.15);ctx.beginPath();ctx.moveTo(tx,o.y+o.h*0.55);
        ctx.quadraticCurveTo(tx+Math.sin(frameCount*0.06+t+i)*5,o.y+o.h*0.75,
          tx+Math.sin(frameCount*0.04+t*2+i)*4,o.y+o.h);ctx.stroke();
      }
      ctx.shadowColor=o.color;ctx.shadowBlur=15;ctx.globalAlpha=0.2;
      ctx.fillStyle=o.color;ctx.beginPath();
      ctx.ellipse(o.x+o.w/2,o.y+o.h*0.35,o.w*0.6,o.h*0.4,0,0,Math.PI*2);ctx.fill();
      ctx.shadowBlur=0;ctx.globalAlpha=1;

    } else if(o.type==='urchin'){
      ctx.fillStyle='#1A0A20';ctx.beginPath();
      ctx.arc(o.x+o.w/2,o.y+o.h/2,o.w*0.35,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='#3A1A40';ctx.lineWidth=1.5;
      for(var s=0;s<14;s++){
        var angle=(s/14)*Math.PI*2;
        var sLen=o.w*0.5+Math.sin(frameCount*0.08+s)*2;
        ctx.beginPath();ctx.moveTo(o.x+o.w/2,o.y+o.h/2);
        ctx.lineTo(o.x+o.w/2+Math.cos(angle)*sLen,o.y+o.h/2+Math.sin(angle)*sLen);ctx.stroke();
      }
      ctx.fillStyle='rgba(100,50,120,0.3)';ctx.beginPath();
      ctx.arc(o.x+o.w*0.4,o.y+o.h*0.38,3*scale,0,Math.PI*2);ctx.fill();

    } else if(o.type==='coral_block'){
      ctx.fillStyle=o.color;ctx.globalAlpha=0.85;
      ctx.beginPath();
      if(o.fromLeft){
        ctx.moveTo(0,o.y);ctx.lineTo(o.w*0.7,o.y+3);
        ctx.quadraticCurveTo(o.w,o.y+o.h/2,o.w*0.8,o.y+o.h-3);ctx.lineTo(0,o.y+o.h);
      } else {
        ctx.moveTo(W,o.y);ctx.lineTo(W-o.w*0.7,o.y+3);
        ctx.quadraticCurveTo(W-o.w,o.y+o.h/2,W-o.w*0.8,o.y+o.h-3);ctx.lineTo(W,o.y+o.h);
      }
      ctx.fill();
      ctx.fillStyle='rgba(255,255,255,0.15)';
      for(var d=0;d<6;d++){
        var dx=o.fromLeft?Math.random()*o.w*0.6+5:W-Math.random()*o.w*0.6-5;
        ctx.beginPath();ctx.arc(dx,o.y+5+Math.random()*(o.h-10),2+Math.random()*2,0,Math.PI*2);ctx.fill();
      }
      ctx.globalAlpha=1;

    } else if(o.type==='rock'){
      var rkGrad=ctx.createLinearGradient(o.x,o.y,o.x,o.y+o.h);
      rkGrad.addColorStop(0,'#3D4448');rkGrad.addColorStop(1,'#2D3436');
      ctx.fillStyle=rkGrad;ctx.beginPath();
      ctx.moveTo(o.x+8,o.y);ctx.lineTo(o.x+o.w-6,o.y+4);ctx.lineTo(o.x+o.w,o.y+o.h*0.6);
      ctx.lineTo(o.x+o.w-10,o.y+o.h);ctx.lineTo(o.x+4,o.y+o.h-3);
      ctx.lineTo(o.x,o.y+o.h*0.4);ctx.closePath();ctx.fill();
      ctx.fillStyle='rgba(255,255,255,0.06)';ctx.beginPath();
      ctx.ellipse(o.x+o.w*0.35,o.y+o.h*0.3,o.w*0.2,o.h*0.15,-0.3,0,Math.PI*2);ctx.fill();

    } else if(o.type==='pufferfish'){
      var puffPulse=1+0.1*Math.sin(frameCount*0.1+i);
      var pRadius=o.w*0.45*puffPulse;
      ctx.fillStyle=C.pufferYellow;ctx.beginPath();
      ctx.arc(o.x+o.w/2,o.y+o.h/2,pRadius,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='rgba(180,120,40,0.4)';
      ctx.beginPath();ctx.arc(o.x+o.w*0.35,o.y+o.h*0.35,2,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(o.x+o.w*0.6,o.y+o.h*0.55,2.5,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='#C8A040';ctx.lineWidth=1;
      for(var s=0;s<10;s++){
        var sA=(s/10)*Math.PI*2;ctx.beginPath();
        ctx.moveTo(o.x+o.w/2+Math.cos(sA)*pRadius,o.y+o.h/2+Math.sin(sA)*pRadius);
        ctx.lineTo(o.x+o.w/2+Math.cos(sA)*(pRadius+4),o.y+o.h/2+Math.sin(sA)*(pRadius+4));
        ctx.stroke();
      }
      ctx.fillStyle='#FFF';ctx.beginPath();ctx.arc(o.x+o.w*0.6,o.y+o.h*0.38,4,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#222';ctx.beginPath();ctx.arc(o.x+o.w*0.62,o.y+o.h*0.38,2,0,Math.PI*2);ctx.fill();
      ctx.fillStyle=C.pufferYellow;ctx.beginPath();
      ctx.moveTo(o.x+3,o.y+o.h/2);ctx.lineTo(o.x-5,o.y+o.h*0.3);
      ctx.lineTo(o.x-5,o.y+o.h*0.7);ctx.closePath();ctx.fill();

    } else if(o.type==='mine'){
      // â˜… Sea Mine
      // Chain
      ctx.strokeStyle='#444';ctx.lineWidth=2;
      ctx.setLineDash([4,3]);
      ctx.beginPath();ctx.moveTo(o.x+o.w/2,o.y+o.h);
      ctx.lineTo(o.x+o.w/2,o.y+o.h+o.chainLen);ctx.stroke();
      ctx.setLineDash([]);

      // Mine body
      ctx.fillStyle=C.mineBlack;ctx.beginPath();
      ctx.arc(o.x+o.w/2,o.y+o.h/2,o.w*0.4,0,Math.PI*2);ctx.fill();

      // Spikes
      ctx.fillStyle='#2A2A3A';
      for(var s=0;s<8;s++){
        var sA=(s/8)*Math.PI*2+frameCount*0.01;
        var sx2=o.x+o.w/2+Math.cos(sA)*o.w*0.4;
        var sy2=o.y+o.h/2+Math.sin(sA)*o.w*0.4;
        ctx.beginPath();ctx.moveTo(sx2,sy2);
        ctx.lineTo(sx2+Math.cos(sA)*8,sy2+Math.sin(sA)*8);
        ctx.lineTo(sx2+Math.cos(sA+0.3)*3,sy2+Math.sin(sA+0.3)*3);
        ctx.closePath();ctx.fill();
      }

      // Red blink
      var blink=Math.sin(frameCount*0.15+i*2);
      if(blink>0.3){
        ctx.fillStyle=C.mineRed;ctx.shadowColor=C.mineRed;ctx.shadowBlur=8;
        ctx.beginPath();ctx.arc(o.x+o.w/2,o.y+o.h*0.35,3,0,Math.PI*2);ctx.fill();
        ctx.shadowBlur=0;
      }

      // Bolts
      ctx.fillStyle='#555';
      ctx.beginPath();ctx.arc(o.x+o.w*0.35,o.y+o.h*0.5,2,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(o.x+o.w*0.65,o.y+o.h*0.5,2,0,Math.PI*2);ctx.fill();

    } else if(o.type==='shark'){
      // â˜… Shark
      var dir=o.fromLeft?1:-1;
      ctx.save();
      ctx.translate(o.x+o.w/2,o.y+o.h/2);
      ctx.scale(dir,1);

      // Body
      var shGrad=ctx.createLinearGradient(0,-o.h/2,0,o.h/2);
      shGrad.addColorStop(0,C.sharkGray);shGrad.addColorStop(1,C.sharkDark);
      ctx.fillStyle=shGrad;
      ctx.beginPath();
      ctx.ellipse(0,0,o.w*0.5,o.h*0.4,0,0,Math.PI*2);ctx.fill();

      // Nose
      ctx.beginPath();ctx.moveTo(o.w*0.45,0);
      ctx.lineTo(o.w*0.6,-o.h*0.1);ctx.lineTo(o.w*0.6,o.h*0.15);ctx.closePath();ctx.fill();

      // Dorsal fin
      ctx.fillStyle=C.sharkGray;ctx.beginPath();
      ctx.moveTo(-o.w*0.05,-o.h*0.35);
      ctx.lineTo(o.w*0.1,-o.h*0.7);
      ctx.lineTo(o.w*0.2,-o.h*0.35);ctx.closePath();ctx.fill();

      // Tail
      var tailWag=Math.sin(frameCount*0.2+i)*0.2;
      ctx.save();ctx.rotate(tailWag);
      ctx.beginPath();ctx.moveTo(-o.w*0.4,0);
      ctx.lineTo(-o.w*0.7,-o.h*0.4);
      ctx.lineTo(-o.w*0.55,0);
      ctx.lineTo(-o.w*0.7,o.h*0.3);ctx.closePath();ctx.fill();
      ctx.restore();

      // Belly
      ctx.fillStyle='#8898A8';
      ctx.beginPath();ctx.ellipse(0,o.h*0.1,o.w*0.35,o.h*0.15,0,0,Math.PI);ctx.fill();

      // Eye
      ctx.fillStyle='#111';ctx.beginPath();
      ctx.arc(o.w*0.25,-o.h*0.08,3,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#FF3030';ctx.beginPath();
      ctx.arc(o.w*0.25,-o.h*0.08,1.5,0,Math.PI*2);ctx.fill();

      // Gill lines
      ctx.strokeStyle='rgba(0,0,0,0.3)';ctx.lineWidth=1;
      for(var g=0;g<3;g++){
        ctx.beginPath();ctx.moveTo(o.w*0.12+g*4,-o.h*0.15);
        ctx.lineTo(o.w*0.12+g*4,o.h*0.05);ctx.stroke();
      }

      // Teeth hint
      ctx.fillStyle='#FFF';
      ctx.beginPath();ctx.moveTo(o.w*0.42,o.h*0.05);
      ctx.lineTo(o.w*0.45,o.h*0.12);ctx.lineTo(o.w*0.48,o.h*0.05);ctx.fill();
      ctx.beginPath();ctx.moveTo(o.w*0.36,o.h*0.04);
      ctx.lineTo(o.w*0.39,o.h*0.11);ctx.lineTo(o.w*0.42,o.h*0.04);ctx.fill();

      ctx.restore();

    } else if(o.type==='eel'){
      // â˜… Electric Eel
      var eelPhase=frameCount*0.08+i;
      var segments=12;
      ctx.lineWidth=8;ctx.lineCap='round';

            // Electric glow
      ctx.shadowColor=C.eelGreen;ctx.shadowBlur=12;
      ctx.strokeStyle=C.eelGreen;ctx.globalAlpha=0.3;
      ctx.beginPath();
      for(var s=0;s<segments;s++){
        var sx3=o.x+s*(o.w/segments);
        var sy3=o.y+o.h/2+Math.sin(eelPhase+s*0.5)*8;
        if(s===0) ctx.moveTo(sx3,sy3);
        else ctx.lineTo(sx3,sy3);
      }
      ctx.stroke();
      ctx.globalAlpha=1;

      // Eel body
      ctx.strokeStyle=C.eelDark;ctx.lineWidth=6;
      ctx.beginPath();
      for(var s=0;s<segments;s++){
        var sx4=o.x+s*(o.w/segments);
        var sy4=o.y+o.h/2+Math.sin(eelPhase+s*0.5)*8;
        if(s===0) ctx.moveTo(sx4,sy4);
        else ctx.lineTo(sx4,sy4);
      }
      ctx.stroke();

      // Lighter belly stripe
      ctx.strokeStyle=C.eelGreen;ctx.lineWidth=2.5;
      ctx.beginPath();
      for(var s=0;s<segments;s++){
        var sx5=o.x+s*(o.w/segments);
        var sy5=o.y+o.h/2+Math.sin(eelPhase+s*0.5)*8+2;
        if(s===0) ctx.moveTo(sx5,sy5);
        else ctx.lineTo(sx5,sy5);
      }
      ctx.stroke();
      ctx.shadowBlur=0;

      // Head
      var headX=o.x+o.w;
      var headY=o.y+o.h/2+Math.sin(eelPhase+segments*0.5)*8;
      ctx.fillStyle=C.eelDark;
      ctx.beginPath();ctx.ellipse(headX,headY,6,5,0,0,Math.PI*2);ctx.fill();

      // Eye
      ctx.fillStyle='#FFE040';ctx.beginPath();
      ctx.arc(headX+3,headY-2,2.5,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#000';ctx.beginPath();
      ctx.arc(headX+3.5,headY-2,1.2,0,Math.PI*2);ctx.fill();

      // Electric sparks
      if(Math.sin(frameCount*0.2+i)>0.5){
        ctx.strokeStyle='#80FFD0';ctx.lineWidth=1;ctx.globalAlpha=0.7;
        for(var sp=0;sp<3;sp++){
          var spx=o.x+Math.random()*o.w;
          var spy=o.y+o.h/2+Math.sin(eelPhase+sp*2)*8;
          ctx.beginPath();ctx.moveTo(spx,spy);
          ctx.lineTo(spx+(Math.random()-0.5)*12,spy+(Math.random()-0.5)*12);
          ctx.lineTo(spx+(Math.random()-0.5)*16,spy+(Math.random()-0.5)*16);
          ctx.stroke();
        }
        ctx.globalAlpha=1;
      }

      // Tail
      var tailX=o.x;
      var tailY=o.y+o.h/2+Math.sin(eelPhase)*8;
      ctx.fillStyle=C.eelDark;
      ctx.beginPath();
      ctx.moveTo(tailX,tailY-3);ctx.lineTo(tailX-8,tailY);
      ctx.lineTo(tailX,tailY+3);ctx.closePath();ctx.fill();
    }
  }
}

/* ============================================================
   DRAW PEARLS
============================================================ */
function drawPearls(){
  for(var i=0;i<collectPearls.length;i++){
    var p=collectPearls[i];
    if(p.collected) continue;
    var bob=Math.sin(frameCount*0.06+i*2)*3;

    ctx.shadowColor='#E0F0FF';ctx.shadowBlur=15;
    var pGrad=ctx.createRadialGradient(p.x-2,p.y+bob-2,1,p.x,p.y+bob,p.size*scale*0.5);
    pGrad.addColorStop(0,'#FFFFFF');pGrad.addColorStop(0.4,'#E8F4FF');
    pGrad.addColorStop(0.8,'#B0D0E8');pGrad.addColorStop(1,'#8AB8D8');
    ctx.fillStyle=pGrad;ctx.beginPath();
    ctx.arc(p.x,p.y+bob,p.size*scale*0.45,0,Math.PI*2);ctx.fill();

    ctx.fillStyle='rgba(255,255,255,0.7)';ctx.beginPath();
    ctx.arc(p.x-p.size*0.15,p.y+bob-p.size*0.15,p.size*scale*0.15,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;

    ctx.globalAlpha=0.3+0.2*Math.sin(frameCount*0.1+i);
    ctx.strokeStyle='#E0F0FF';ctx.lineWidth=1;ctx.beginPath();
    ctx.arc(p.x,p.y+bob,p.size*scale*0.65,0,Math.PI*2);ctx.stroke();
    ctx.globalAlpha=1;

    ctx.fillStyle='#C8A070';ctx.globalAlpha=0.4;ctx.beginPath();
    ctx.ellipse(p.x,p.y+bob+p.size*0.4,p.size*0.55,p.size*0.2,0,0,Math.PI);ctx.fill();
    ctx.globalAlpha=1;
  }
}

/* ============================================================
   DRAW PARTICLES
============================================================ */
function drawParticles(){
  for(var i=0;i<particles.length;i++){
    var p=particles[i];
    var alpha=p.life/p.maxLife;
    ctx.globalAlpha=alpha;

    if(p.type==='bubble'){
      var wobble=Math.sin(frameCount*p.wobbleSpeed+p.wobble)*3;
      ctx.strokeStyle='rgba(180,230,255,0.5)';ctx.lineWidth=1;ctx.beginPath();
      ctx.arc(p.x+wobble,p.y,p.size,0,Math.PI*2);ctx.stroke();
      ctx.fillStyle='rgba(220,250,255,0.15)';ctx.beginPath();
      ctx.arc(p.x+wobble-p.size*0.2,p.y-p.size*0.2,p.size*0.3,0,Math.PI*2);ctx.fill();
    } else if(p.type==='sparkle'){
      ctx.fillStyle=p.color;ctx.beginPath();
      ctx.arc(p.x,p.y,p.size*alpha,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle=p.color;ctx.lineWidth=0.5;ctx.beginPath();
      ctx.moveTo(p.x-p.size*1.5*alpha,p.y);ctx.lineTo(p.x+p.size*1.5*alpha,p.y);
      ctx.moveTo(p.x,p.y-p.size*1.5*alpha);ctx.lineTo(p.x,p.y+p.size*1.5*alpha);
      ctx.stroke();
    } else if(p.type==='hit'){
      ctx.fillStyle=p.color;
      ctx.fillRect(p.x-p.size/2,p.y-p.size/2,p.size,p.size);
    }
  }
  ctx.globalAlpha=1;
}

/* ============================================================
   DRAW WARNINGS (shark incoming!)
============================================================ */
function drawWarnings(){
  for(var i=warnings.length-1;i>=0;i--){
    var w=warnings[i];
    var alpha=(w.life/w.maxLife);
    var flash=Math.sin(frameCount*0.4)*0.5+0.5;

    ctx.globalAlpha=alpha*flash*0.6;
    ctx.fillStyle='#FF2040';

    if(w.side==='left'){
      // Arrow on left
      ctx.beginPath();
      ctx.moveTo(15,H*0.4);ctx.lineTo(35,H*0.35);
      ctx.lineTo(35,H*0.45);ctx.closePath();ctx.fill();
      ctx.font=(8*scale)+'px "Press Start 2P"';
      ctx.fillText('âš ',40,H*0.42);
    } else {
      ctx.beginPath();
      ctx.moveTo(W-15,H*0.4);ctx.lineTo(W-35,H*0.35);
      ctx.lineTo(W-35,H*0.45);ctx.closePath();ctx.fill();
      ctx.font=(8*scale)+'px "Press Start 2P"';
      ctx.textAlign='right';
      ctx.fillText('âš ',W-40,H*0.42);
      ctx.textAlign='left';
    }
    ctx.globalAlpha=1;

    w.life--;
    if(w.life<=0) warnings.splice(i,1);
  }
}

/* ============================================================
   DRAW HUD
============================================================ */
function drawHUD(){
  var barX=W*0.3,barY=12*scale,barW=W*0.4,barH=10*scale;
  ctx.fillStyle='rgba(255,255,255,0.08)';
  ctx.beginPath();ctx.roundRect(barX,barY,barW,barH,5);ctx.fill();

  var pct=Math.min(depth/maxDepth,1);
  var fillGrad=ctx.createLinearGradient(barX,0,barX+barW,0);
  fillGrad.addColorStop(0,'#00B4D8');fillGrad.addColorStop(0.5,'#0077B6');
  fillGrad.addColorStop(1,'#023E8A');
  ctx.fillStyle=fillGrad;ctx.beginPath();
  ctx.roundRect(barX,barY,barW*pct,barH,5);ctx.fill();

  ctx.font=(8*scale)+'px sans-serif';
  ctx.fillText('ğŸ¤¿',barX-18,barY+barH-1);
  ctx.fillText('ğŸ’',barX+barW+5,barY+barH-1);

  // Lives (air bubbles)
  ctx.font=(14*scale)+'px sans-serif';
  for(var i=0;i<3;i++){
    ctx.globalAlpha=i<lives?1:0.2;
    ctx.fillText('ğŸ«§',W-80*scale+i*22*scale,22*scale);
  }
  ctx.globalAlpha=1;

  // Depth meter
  ctx.fillStyle='#5090B0';ctx.font=(7*scale)+'px "Press Start 2P"';
  ctx.textAlign='right';
  ctx.fillText(Math.floor(depth*0.3)+'m deep',W-12,40*scale);
  ctx.textAlign='left';

  // Pearls
  if(pearls>0){
    ctx.fillStyle='#E0F0FF';ctx.font=(7*scale)+'px "Press Start 2P"';
    ctx.fillText('ğŸ’ x'+pearls,12,22*scale);
  }

  // World label
  ctx.fillStyle='#00E5FF';ctx.font=(7*scale)+'px "Press Start 2P"';
  ctx.fillText('WORLD 2-1',12,40*scale);

  // Difficulty indicator
  var dp=getDepthProgress();
  var diffTxt='';var diffCol='';
  if(dp<0.25){diffTxt='~ CALM ~';diffCol='#4DC8FF';}
  else if(dp<0.5){diffTxt='~ DANGER ~';diffCol='#FFB040';}
  else if(dp<0.75){diffTxt='~ DEADLY ~';diffCol='#FF6040';}
  else{diffTxt='~ ABYSS ~';diffCol='#FF2060';}

  ctx.fillStyle=diffCol;ctx.globalAlpha=0.4+0.15*Math.sin(frameCount*0.05);
  ctx.font=(5*scale)+'px "Press Start 2P"';ctx.textAlign='center';
  ctx.fillText(diffTxt,W/2,H-15*scale);
  ctx.textAlign='left';ctx.globalAlpha=1;
}

/* ============================================================
   GAME LOGIC
============================================================ */
function update(){
  if(STATE!=='playing') return;

  frameCount++;
  depth++;

  // Speed ramps up more aggressively
  var dp=getDepthProgress();
  speed=baseSpeed+dp*4;
if(speed>6.5) speed=6.5;

  // Dynamic difficulty
  difficulty=1+dp*2.5;

  if(frameCount%10===0) spawnBubbleParticle();

  // Player movement
  if(movingLeft) player.vx-=PLAYER_ACCEL;
  if(movingRight) player.vx+=PLAYER_ACCEL;
  player.vx*=PLAYER_FRICTION;
  player.x+=player.vx;

  if(player.x<10){player.x=10;player.vx=0;}
  if(player.x+player.w>W-10){player.x=W-10-player.w;player.vx=0;}

  player.swimFrame++;

  // Obstacle spawning â€” gets faster with depth
  obsSpawnTimer++;
  var spawnRate=Math.max(45, obsSpawnInterval-dp*30);
  if(obsSpawnTimer>=spawnRate){
    obsSpawnTimer=0;
    spawnObstacle();
  }

  // Pearl spawning
  pearlSpawnTimer++;
  if(pearlSpawnTimer>=100+Math.random()*60){
    pearlSpawnTimer=0;
    if(Math.random()>0.35) spawnPearl();
  }

  // Move obstacles
  for(var i=obstacles.length-1;i>=0;i--){
    var o=obstacles[i];

    if(o.type==='shark'){
      // Sharks move horizontally + slowly rise
      o.x+=o.sharkSpeed;
      o.y-=speed*0.5;
      // Remove if off screen
      if((o.fromLeft && o.x>W+100)||(!o.fromLeft && o.x<-100)||o.y<-100){
        obstacles.splice(i,1);continue;
      }
    } else if(o.type==='eel'){
      // Eels zigzag
      o.y-=speed;
      o.x=o.baseX+Math.sin(frameCount*o.zigSpeed+o.zigOffset)*o.zigRange;
    } else {
      o.y-=speed;
    }

    // Jellyfish & pufferfish & mine drift
    if(o.type==='jellyfish'||o.type==='pufferfish'){
      o.x=o.baseX+Math.sin(frameCount*o.driftSpeed+o.driftOffset)*o.driftRange;
    }
    if(o.type==='mine'){
      o.x=o.baseX+Math.sin(frameCount*o.driftSpeed+o.driftOffset)*o.driftRange;
      o.y-=speed;
    }

    if(o.y<-100&&o.type!=='shark'){obstacles.splice(i,1);continue;}

    // Collision
    var px=player.x,py=player.y,pw=player.w,ph=player.h;
    var hitShrink=6;

    // Special hitbox for shark (wider)
    var oLeft=o.x, oRight=o.x+o.w, oTop=o.y, oBot=o.y+o.h;
    if(o.type==='eel'){
      // Eel hitbox follows its zigzag body center
      oTop=o.y+o.h/2-10;oBot=o.y+o.h/2+10;
    }

    if(px+pw-hitShrink>oLeft+hitShrink && px+hitShrink<oRight-hitShrink &&
       py+ph-hitShrink>oTop+hitShrink && py+hitShrink<oBot-hitShrink){

      if(invincible<=0){
        lives--;
        invincible=60;
        emitHitParticles(px+pw/2,py+ph/2);
        worldE_shake();

        // Sharks and mines do 2 damage!
        if(o.type==='shark'||o.type==='mine'){
          lives--;
          // Extra shake
          shakeAmount=10;shakeDuration=20;
        }

        if(lives<=0){
          lives=0;
          STATE='over';
          document.getElementById('goScore').textContent=Math.floor(depth*0.3)+'m  ğŸ’x'+pearls;
          setTimeout(function(){oGo.classList.add('show')},500);
          return;
        }
      }
    }
  }

  // Shark warning spawn
  if(dp>0.3 && Math.random()<0.003*difficulty){
    var side=Math.random()>0.5?'left':'right';
    addWarning(side,60);
  }

  // Move pearls
  for(var i=collectPearls.length-1;i>=0;i--){
    collectPearls[i].y-=speed;
    if(collectPearls[i].y<-50){collectPearls.splice(i,1);continue;}

    var cp=collectPearls[i];
    if(!cp.collected){
      if(player.x+player.w>cp.x-cp.size&&
         player.x<cp.x+cp.size&&
         player.y+player.h>cp.y-cp.size&&
         player.y<cp.y+cp.size*1.5){
        cp.collected=true;
        pearls++;
        emitPearlCollect(cp.x,cp.y);
      }
    }
  }

  // Update particles
  for(var i=particles.length-1;i>=0;i--){
    var p=particles[i];
    p.x+=p.vx;p.y+=p.vy;p.life--;
    if(p.type==='bubble'){p.y-=speed*0.2;p.vy-=0.01;}
    if(p.type==='sparkle'){p.vy-=0.03;}
    if(p.type==='hit'){p.vx*=0.95;p.vy*=0.95;}
    if(p.life<=0) particles.splice(i,1);
  }

  if(invincible>0) invincible--;

  // Win condition
  if(depth>=maxDepth){
    STATE='won';
    showWinEffects();
    setTimeout(function(){showWinEffects();},1200);
    setTimeout(function(){oStory.classList.add('show');},3000);
    return;
  }
}

/* ============================================================
   CAMERA SHAKE
============================================================ */
var shakeAmount=0;
var shakeDuration=0;

function worldE_shake(){shakeAmount=6;shakeDuration=15;}

function getShakeOffset(){
  if(shakeDuration>0){
    shakeDuration--;
    var intensity=(shakeDuration/15)*shakeAmount;
    return {x:(Math.random()-0.5)*intensity*2, y:(Math.random()-0.5)*intensity*2};
  }
  return {x:0,y:0};
}

/* ============================================================
   WIN EFFECTS
============================================================ */
function showWinEffects(){
  for(var i=0;i<30;i++){
    (function(idx){
      setTimeout(function(){
        particles.push({
          x:W*0.2+Math.random()*W*0.6, y:H*0.3+Math.random()*H*0.3,
          vx:(Math.random()-0.5)*3, vy:-1-Math.random()*2,
          life:60+Math.random()*40, maxLife:100,
          size:5+Math.random()*6, type:'sparkle',
          color:['#FFD700','#00E5FF','#FF80C0','#40FF80','#A0D0FF','#FF40FF','#00FFCC'][Math.floor(Math.random()*7)]
        });
      },idx*60);
    })(i);
  }
  for(var i=0;i<20;i++){
    (function(idx){
      setTimeout(function(){
        particles.push({
          x:W*0.2+Math.random()*W*0.6, y:H*0.5+Math.random()*H*0.3,
          vx:(Math.random()-0.5)*2, vy:-2-Math.random()*3,
          life:80+Math.random()*40, maxLife:120,
          size:4+Math.random()*8, type:'bubble',
          wobble:Math.random()*Math.PI*2, wobbleSpeed:0.04+Math.random()*0.03
        });
      },idx*70);
    })(i);
  }
}

/* ============================================================
   MAIN RENDER
============================================================ */
function render(){
  ctx.clearRect(0,0,W,H);
  var shake=getShakeOffset();
  ctx.save();ctx.translate(shake.x,shake.y);

  drawWater();drawLightRays();drawCaustics();drawSurface();
  drawFarRocks();drawBgFish();drawBgBubbles();
  drawCoralWalls();drawBioluminescence();

  if(STATE==='playing'||STATE==='won'||STATE==='over'){
    drawObstacles();drawPearls();drawPlayer();
    drawParticles();drawWarnings();drawHUD();
  }

  ctx.restore();
}

/* ============================================================
   INPUT
============================================================ */
function startMoveLeft(){movingLeft=true;}
function stopMoveLeft(){movingLeft=false;}
function startMoveRight(){movingRight=true;}
function stopMoveRight(){movingRight=false;}

document.addEventListener('keydown',function(e){
  if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A'){e.preventDefault();startMoveLeft();}
  if(e.key==='ArrowRight'||e.key==='d'||e.key==='D'){e.preventDefault();startMoveRight();}
});
document.addEventListener('keyup',function(e){
  if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A') stopMoveLeft();
  if(e.key==='ArrowRight'||e.key==='d'||e.key==='D') stopMoveRight();
});
window.addEventListener('keydown',function(e){if(e.key===' ') e.preventDefault();});

var mLb=document.getElementById('mL');
var mRb=document.getElementById('mR');

mLb.addEventListener('touchstart',function(e){e.preventDefault();startMoveLeft();},{passive:false});
mLb.addEventListener('touchend',function(){stopMoveLeft();});
mLb.addEventListener('touchcancel',function(){stopMoveLeft();});
mLb.addEventListener('mousedown',function(){startMoveLeft();});
mLb.addEventListener('mouseup',function(){stopMoveLeft();});
mLb.addEventListener('mouseleave',function(){stopMoveLeft();});

mRb.addEventListener('touchstart',function(e){e.preventDefault();startMoveRight();},{passive:false});
mRb.addEventListener('touchend',function(){stopMoveRight();});
mRb.addEventListener('touchcancel',function(){stopMoveRight();});
mRb.addEventListener('mousedown',function(){startMoveRight();});
mRb.addEventListener('mouseup',function(){stopMoveRight();});
mRb.addEventListener('mouseleave',function(){stopMoveRight();});

var sx=0,sy=0;
document.addEventListener('touchstart',function(e){
  sx=e.touches[0].clientX;sy=e.touches[0].clientY;
},{passive:true});
document.addEventListener('touchmove',function(e){
  if(STATE!=='playing') return;
  var dx=e.touches[0].clientX-sx;
  if(dx<-20){startMoveLeft();stopMoveRight();}
  else if(dx>20){startMoveRight();stopMoveLeft();}
  else{stopMoveLeft();stopMoveRight();}
},{passive:true});
document.addEventListener('touchend',function(){
  stopMoveLeft();stopMoveRight();
},{passive:true});

/* ============================================================
   OVERLAY REFERENCES
============================================================ */
var oStart=document.getElementById('oStart');
var oGo=document.getElementById('oGo');
var oStory=document.getElementById('oStory');

/* ============================================================
   START / RESTART
============================================================ */
function startGame(){
  oStart.classList.remove('show');
  oGo.classList.remove('show');
  oStory.classList.remove('show');

  if('ontouchstart' in window) document.getElementById('mob').classList.add('show');

  STATE='playing';
  depth=0;speed=baseSpeed;lives=3;pearls=0;
  invincible=0;frameCount=0;difficulty=1;
  obstacles=[];collectPearls=[];particles=[];warnings=[];
  obsSpawnTimer=0;pearlSpawnTimer=0;
  shakeAmount=0;shakeDuration=0;
  movingLeft=false;movingRight=false;

  resize();resetPlayer();invincible=30;
}

document.getElementById('btnStart').addEventListener('click',startGame);
document.getElementById('btnRetry').addEventListener('click',startGame);
document.addEventListener('contextmenu',function(e){e.preventDefault();});

/* ============================================================
   IDLE ANIMATION (menu)
============================================================ */
function idleLoop(){
  if(STATE==='menu'){
    frameCount++;depth+=0.5;
    ctx.clearRect(0,0,W,H);
    drawWater();drawLightRays();drawCaustics();
    drawFarRocks();drawBgFish();drawBgBubbles();drawCoralWalls();
    if(frameCount%15===0) spawnBubbleParticle();
    for(var i=particles.length-1;i>=0;i--){
      var p=particles[i];p.x+=p.vx;p.y+=p.vy;p.life--;
      if(p.type==='bubble'){p.vy-=0.005;p.x+=Math.sin(frameCount*p.wobbleSpeed+p.wobble)*0.3;}
      if(p.life<=0) particles.splice(i,1);
    }
    drawParticles();
  }
}

/* ============================================================
   MASTER LOOP
============================================================ */
function masterLoop(){
  if(STATE==='menu') idleLoop();
  else{update();render();}
  requestAnimationFrame(masterLoop);
}

resize();resetPlayer();masterLoop();

})();
</script>
</body>
</html>